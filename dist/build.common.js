"use strict";var e=require("child_process"),t=require("cluster"),s=require("crypto"),r=require("events"),i=require("assert"),n=require("util"),o=require("url"),a=require("tty"),l=require("os"),c=require("stream"),u=require("dns"),h=require("net"),d=require("tls"),p=require("buffer"),f=require("string_decoder");function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var m=y(t),g=y(s),b=y(r),k=y(i),S=y(n),_=y(o),w=y(a),v=y(l),E=y(c),C=y(u),x=y(h),A=y(d),T=y(p),R=y(f),M="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function O(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var P=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=void 0===e?1:e}get msDuration(){return 1e3*this.duration}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=void 0===e?0:e}get msBlockDuration(){return 1e3*this.blockDuration}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=void 0!==e&&Boolean(e)}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=void 0===e?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(void 0===e&&(e="rlflx"),"string"!=typeof e)throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}};const B=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach((t=>{this._keys[t]<=e&&delete this._keys[t]})),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,1e3*t)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const e=Date.now();return t>=e?t-e:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach((e=>{delete this._keys[e]}))}};var N=B,I=class{constructor(e,t,s,r){this.remainingPoints=void 0===e?0:e,this.msBeforeNext=void 0===t?0:t,this.consumedPoints=void 0===s?0:s,this.isFirstInDuration=void 0!==r&&r}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=Boolean(e)}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const D=P,L=N,j=I;var F=class extends D{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new L}get client(){return this._client}set client(e){if(void 0===e)throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,s,r,i,n={}){const o=this._getRateLimiterRes(s,r,i);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&o.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(s,o.msBeforeNext),o.consumedPoints>this.points?t(o):e(o);if(o.consumedPoints>this.points){let e=Promise.resolve();this.blockDuration>0&&o.consumedPoints<=this.points+r&&(o.msBeforeNext=this.msBlockDuration,e=this._block(s,o.consumedPoints,this.msBlockDuration,n)),this.inMemoryBlockOnConsumed>0&&o.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(s,this.inMemoryBlockDuration),o.msBeforeNext=this.msInMemoryBlockDuration),e.then((()=>{t(o)})).catch((e=>{t(e)}))}else if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let t=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));t<this.execEvenlyMinDelayMs&&(t=o.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,t,o)}else e(o)}_handleError(e,t,s,r,i,n=!1,o={}){this.insuranceLimiter instanceof D?this.insuranceLimiter[t](i,n,o).then((e=>{s(e)})).catch((e=>{r(e)})):r(e)}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&0===this.inMemoryBlockOnConsumed)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return 1e3*this._inMemoryBlockDuration}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(void 0!==e&&!(e instanceof D))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,s={}){const r=1e3*t;return this._block(this.getKey(e),this.points+1,r,s)}set(e,t,s,r={}){const i=1e3*(s>=0?s:this.duration);return this._block(this.getKey(e),t,i,r)}consume(e,t=1,s={}){return new Promise(((r,i)=>{const n=this.getKey(e),o=this.getInMemoryBlockMsBeforeExpire(n);if(o>0)return i(new j(0,o));this._upsert(n,t,1e3*this._getKeySecDuration(s),!1,s).then((e=>{this._afterConsume(r,i,n,t,e)})).catch((n=>{this._handleError(n,"consume",r,i,e,t,s)}))}))}penalty(e,t=1,s={}){const r=this.getKey(e);return new Promise(((i,n)=>{this._upsert(r,t,1e3*this._getKeySecDuration(s),!1,s).then((e=>{i(this._getRateLimiterRes(r,t,e))})).catch((r=>{this._handleError(r,"penalty",i,n,e,t,s)}))}))}reward(e,t=1,s={}){const r=this.getKey(e);return new Promise(((i,n)=>{this._upsert(r,-t,1e3*this._getKeySecDuration(s),!1,s).then((e=>{i(this._getRateLimiterRes(r,-t,e))})).catch((r=>{this._handleError(r,"reward",i,n,e,t,s)}))}))}get(e,t={}){const s=this.getKey(e);return new Promise(((r,i)=>{this._get(s,t).then((e=>{r(null==e?null:this._getRateLimiterRes(s,0,e))})).catch((s=>{this._handleError(s,"get",r,i,e,t)}))}))}delete(e,t={}){const s=this.getKey(e);return new Promise(((r,i)=>{this._delete(s,t).then((e=>{this._inMemoryBlockedKeys.delete(s),r(e)})).catch((s=>{this._handleError(s,"delete",r,i,e,t)}))}))}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,s){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,s,r={}){return new Promise(((i,n)=>{this._upsert(e,t,s,!0,r).then((()=>{i(new j(0,s>0?s:-1,t))})).catch((t=>{this._handleError(t,"block",i,n,this.parseKey(e),s/1e3,r)}))}))}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,s,r=!1,i={}){throw new Error("You have to implement the method '_upsert'!")}};const Q=F,z=I;var U=class extends Q{constructor(e){super(e),this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,this._incrTtlLuaScript=e.customIncrTtlLuaScript||"redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ",this.useRedisPackage=e.useRedisPackage||"Commander"===this.client.constructor.name||!1,this.useRedis3AndLowerPackage=e.useRedis3AndLowerPackage,"function"==typeof this.client.defineCommand&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:this._incrTtlLuaScript})}_isRedisReady(){return!this._rejectIfRedisNotReady||(!this.client.status||"ready"===this.client.status)&&!("function"==typeof this.client.isReady&&!this.client.isReady())}_getRateLimiterRes(e,t,s){let[r,i]=s;Array.isArray(r)&&([,r]=r,[,i]=i);const n=new z;return n.consumedPoints=parseInt(r),n.isFirstInDuration=n.consumedPoints===t,n.remainingPoints=Math.max(this.points-n.consumedPoints,0),n.msBeforeNext=i,n}async _upsert(e,t,s,r=!1){if(!this._isRedisReady())throw new Error("Redis connection is not ready");const i=Math.floor(s/1e3),n=this.client.multi();return r?(i>0?this.useRedisPackage||this.useRedis3AndLowerPackage?n.set(e,t,{EX:i}):n.set(e,t,"EX",i):n.set(e,t),this.useRedisPackage||this.useRedis3AndLowerPackage?n.pTTL(e).exec(!0):n.pttl(e).exec(!0)):i>0?this.useRedisPackage||this.useRedis3AndLowerPackage?this.useRedis3AndLowerPackage?new Promise(((s,r)=>{const n=function(e,t){return e?r(e):s(t)};"function"==typeof this.client.rlflxIncr?this.client.rlflxIncr(e,t,i,this.points,this.duration,n):this.client.eval(this._incrTtlLuaScript,1,e,t,i,this.points,this.duration,n)})):this.client.eval(this._incrTtlLuaScript,{keys:[e],arguments:[String(t),String(i),String(this.points),String(this.duration)]}):this.client.rlflxIncr([e].concat([String(t),String(i),String(this.points),String(this.duration)])):this.useRedisPackage||this.useRedis3AndLowerPackage?n.incrBy(e,t).pTTL(e).exec(!0):n.incrby(e,t).pttl(e).exec(!0)}async _get(e){if(!this._isRedisReady())throw new Error("Redis connection is not ready");return this.useRedisPackage||this.useRedis3AndLowerPackage?this.client.multi().get(e).pTTL(e).exec(!0).then((e=>{const[t]=e;return null===t?null:e})):this.client.multi().get(e).pttl(e).exec().then((e=>{const[[,t]]=e;return null===t?null:e}))}_delete(e){return this.client.del(e).then((e=>e>0))}};const G=F,K=I;function q(e){try{const t=e.client?e.client:e;let s=[0,0,0];if(void 0===t.topology){const{version:e}=t.options.metadata.driver;s=e.split("|",1)[0].split(".").map((e=>parseInt(e)))}else{const{version:e}=t.topology.s.options.metadata.driver;s=e.split(".").map((e=>parseInt(e)))}return{major:s[0],feature:s[1],patch:s[2]}}catch(e){return{major:0,feature:0,patch:0}}}class Y extends G{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,"function"==typeof this.client.then?this.client.then((e=>{this.client=e,this._initCollection(),this._driverVersion=q(this.client)})):(this._initCollection(),this._driverVersion=q(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=void 0===e?Y.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=void 0===e?this.keyPrefix:e}get client(){return this._client}set client(e){if(void 0===e)throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const e=("function"==typeof this.client.db?this.client.db(this.dbName):this.client).collection(this.tableName);e.createIndex({expire:-1},{expireAfterSeconds:0}),e.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=e}_getRateLimiterRes(e,t,s){const r=new K;let i;return i=void 0===s.value?s:s.value,r.isFirstInDuration=i.points===t,r.consumedPoints=i.points,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=null!==i.expire?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,r}_upsert(e,t,s,r=!1,i={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=i.attrs||{};let o,a;r?(o={key:e},o=Object.assign(o,n),a={$set:{key:e,points:t,expire:s>0?new Date(Date.now()+s):null}},a.$set=Object.assign(a.$set,n)):(o={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},o=Object.assign(o,n),a={$setOnInsert:{key:e,expire:s>0?new Date(Date.now()+s):null},$inc:{points:t}},a.$setOnInsert=Object.assign(a.$setOnInsert,n));const l={upsert:!0};return this._driverVersion.major>=4||3===this._driverVersion.major&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?l.returnDocument="after":l.returnOriginal=!1,new Promise(((i,c)=>{this._collection.findOneAndUpdate(o,a,l).then((e=>{i(e)})).catch((o=>{if(o&&11e3===o.code){const o=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},n),a={$set:Object.assign({key:e,points:t,expire:s>0?new Date(Date.now()+s):null},n)};this._collection.findOneAndUpdate(o,a,l).then((e=>{i(e)})).catch((n=>{n&&11e3===n.code?this._upsert(e,t,s,r).then((e=>i(e))).catch((e=>c(e))):c(n)}))}else c(o)}))}))}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const s=t.attrs||{},r=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},s);return this._collection.findOne(r)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const s=t.attrs||{},r=Object.assign({key:e},s);return this._collection.deleteOne(r).then((e=>e.deletedCount>0))}}var W=Y;const V=F,H=I;var J=class extends V{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),"function"==typeof t&&t()):this._createDbAndTable().then((()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),"function"==typeof t&&t()})).catch((e=>{if("function"!=typeof t)throw e;t(e)}))}clearExpired(e){return new Promise((t=>{this._getConnection().then((s=>{s.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],(()=>{this._releaseConnection(s),t()}))})).catch((()=>{t()}))}))}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout((()=>{this.clearExpired(Date.now()-36e5).then((()=>{this._clearExpiredHourAgo()}))}),3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise(((e,t)=>{this.client.getConnection(((s,r)=>{if(s)return t(s);e(r)}))}));case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise(((e,t)=>{this._getConnection().then((s=>{s.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,(r=>{if(r)return this._releaseConnection(s),t(r);s.query(this._getCreateTableStmt(),(r=>{if(r)return this._releaseConnection(s),t(r);this._releaseConnection(s),e()}))}))})).catch((e=>{t(e)}))}))}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(void 0===e)if("Connection"===this.client.constructor.name)e="connection";else if("Pool"===this.client.constructor.name)e="pool";else{if("Sequelize"!==this.client.constructor.name)throw new Error("storeType is not defined");e="sequelize"}this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=void 0===e?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=void 0===e?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=void 0!==e&&!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=void 0===e||Boolean(e)}_getRateLimiterRes(e,t,s){const r=new H,[i]=s;return r.isFirstInDuration=t===i.points,r.consumedPoints=r.isFirstInDuration?t:i.points,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,r}_upsertTransaction(e,t,s,r,i){return new Promise(((n,o)=>{e.query("BEGIN",(a=>{if(a)return e.rollback(),o(a);const l=Date.now(),c=r>0?l+r:null;let u,h;i?(u="INSERT INTO ??.?? VALUES (?, ?, ?)\n          ON DUPLICATE KEY UPDATE \n            points = ?, \n            expire = ?;",h=[this.dbName,this.tableName,t,s,c,s,c]):(u="INSERT INTO ??.?? VALUES (?, ?, ?)\n          ON DUPLICATE KEY UPDATE \n            points = IF(expire <= ?, ?, points + (?)), \n            expire = IF(expire <= ?, ?, expire);",h=[this.dbName,this.tableName,t,s,c,l,s,s,l,c]),e.query(u,h,(s=>{if(s)return e.rollback(),o(s);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],((t,s)=>{if(t)return e.rollback(),o(t);e.query("COMMIT",(t=>{if(t)return e.rollback(),o(t);n(s)}))}))}))}))}))}_upsert(e,t,s,r=!1){return this.tableCreated?new Promise(((i,n)=>{this._getConnection().then((o=>{this._upsertTransaction(o,e,t,s,r).then((e=>{i(e),this._releaseConnection(o)})).catch((e=>{n(e),this._releaseConnection(o)}))})).catch((e=>{n(e)}))})):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise(((t,s)=>{this._getConnection().then((r=>{r.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],((e,i)=>{e?s(e):0===i.length?t(null):t(i),this._releaseConnection(r)}))})).catch((e=>{s(e)}))})):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise(((t,s)=>{this._getConnection().then((r=>{r.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],((e,i)=>{e?s(e):t(i.affectedRows>0),this._releaseConnection(r)}))})).catch((e=>{s(e)}))})):Promise.reject(Error("Table is not created yet"))}};const X=F,Z=I;var $=class extends X{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.schemaName=e.schemaName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),"function"==typeof t&&t()):this._createTable().then((()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),"function"==typeof t&&t()})).catch((e=>{if("function"!=typeof t)throw e;t(e)}))}_getTableIdentifier(){return this.schemaName?`"${this.schemaName}"."${this.tableName}"`:`"${this.tableName}"`}clearExpired(e){return new Promise((t=>{const s={name:"rlflx-clear-expired",text:`DELETE FROM ${this._getTableIdentifier()} WHERE expire < $1`,values:[e]};this._query(s).then((()=>{t()})).catch((()=>{t()}))}))}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout((()=>{this.clearExpired(Date.now()-36e5).then((()=>{this._clearExpiredHourAgo()}))}),3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":default:return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master)}}_releaseConnection(e){switch(this.clientType){case"pool":case"typeorm":default:return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e)}}_createTable(){return new Promise(((e,t)=>{this._query({text:this._getCreateTableStmt()}).then((()=>{e()})).catch((s=>{"23505"===s.code?e():t(s)}))}))}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this._getTableIdentifier()} (\n      key varchar(255) PRIMARY KEY,\n      points integer NOT NULL DEFAULT 0,\n      expire bigint\n    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(void 0===e)if("Client"===t)e="client";else if("Pool"===t||"BoundPool"===t)e="pool";else{if("Sequelize"!==t)throw new Error("storeType is not defined");e="sequelize"}this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=void 0===e?this.keyPrefix:e}get schemaName(){return this._schemaName}set schemaName(e){this._schemaName=e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=void 0!==e&&!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=void 0===e||Boolean(e)}_getRateLimiterRes(e,t,s){const r=new Z,i=s.rows[0];return r.isFirstInDuration=t===i.points,r.consumedPoints=r.isFirstInDuration?t:i.points,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,r}_query(e){const t={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise(((e,s)=>{this._getConnection().then((r=>{r.query(t).then((t=>{e(t),this._releaseConnection(r)})).catch((e=>{s(e),this._releaseConnection(r)}))})).catch((e=>{s(e)}))}))}_upsert(e,t,s,r=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const i=s>0?Date.now()+s:null,n=r?" $3 ":` CASE\n             WHEN ${this._getTableIdentifier()}.expire <= $4 THEN $3\n             ELSE ${this._getTableIdentifier()}.expire\n            END `;return this._query({name:r?"rlflx-upsert-force":"rlflx-upsert",text:`\n            INSERT INTO ${this._getTableIdentifier()} VALUES ($1, $2, $3)\n              ON CONFLICT(key) DO UPDATE SET\n                points = CASE\n                          WHEN (${this._getTableIdentifier()}.expire <= $4 OR 1=${r?1:0}) THEN $2\n                          ELSE ${this._getTableIdentifier()}.points + ($2)\n                         END,\n                expire = ${n}\n            RETURNING points, expire;`,values:[e,t,i,Date.now()]})}_get(e){return this.tableCreated?new Promise(((t,s)=>{this._query({name:"rlflx-get",text:`\n            SELECT points, expire FROM ${this._getTableIdentifier()} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then((e=>{0===e.rowCount&&(e=null),t(e)})).catch((e=>{s(e)}))})):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this._getTableIdentifier()} WHERE key = $1`,values:[e]}).then((e=>e.rowCount>0)):Promise.reject(Error("Table is not created yet"))}};const ee=class{constructor(e,t,s=null){this.value=e,this.expiresAt=t,this.timeoutId=s}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){e instanceof Date||!Number.isInteger(e)||(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}},te=I;const se=P,re=class{constructor(){this._storage={}}incrby(e,t,s){if(this._storage[e]){const r=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-(new Date).getTime():-1;return!this._storage[e].expiresAt||r>0?(this._storage[e].value=this._storage[e].value+t,new te(0,r,this._storage[e].value,!1)):this.set(e,t,s)}return this.set(e,t,s)}set(e,t,s){const r=1e3*s;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new ee(t,r>0?new Date(Date.now()+r):null),r>0&&(this._storage[e].timeoutId=setTimeout((()=>{delete this._storage[e]}),r),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new te(0,0===r?-1:r,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-(new Date).getTime():-1;return new te(0,t,this._storage[e].value,!1)}return null}delete(e){return!!this._storage[e]&&(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0)}},ie=I;var ne=class extends se{constructor(e={}){super(e),this._memoryStorage=new re}consume(e,t=1,s={}){return new Promise(((r,i)=>{const n=this.getKey(e),o=this._getKeySecDuration(s);let a=this._memoryStorage.incrby(n,t,o);if(a.remainingPoints=Math.max(this.points-a.consumedPoints,0),a.consumedPoints>this.points)this.blockDuration>0&&a.consumedPoints<=this.points+t&&(a=this._memoryStorage.set(n,a.consumedPoints,this.blockDuration)),i(a);else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let e=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(r,e,a)}else r(a)}))}penalty(e,t=1,s={}){const r=this.getKey(e);return new Promise((e=>{const i=this._getKeySecDuration(s),n=this._memoryStorage.incrby(r,t,i);n.remainingPoints=Math.max(this.points-n.consumedPoints,0),e(n)}))}reward(e,t=1,s={}){const r=this.getKey(e);return new Promise((e=>{const i=this._getKeySecDuration(s),n=this._memoryStorage.incrby(r,-t,i);n.remainingPoints=Math.max(this.points-n.consumedPoints,0),e(n)}))}block(e,t){const s=1e3*t,r=this.points+1;return this._memoryStorage.set(this.getKey(e),r,t),Promise.resolve(new ie(0,0===s?-1:s,r))}set(e,t,s){const r=1e3*(s>=0?s:this.duration);return this._memoryStorage.set(this.getKey(e),t,s),Promise.resolve(new ie(0,0===r?-1:r,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return null!==t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};const oe=m.default,ae=g.default,le=P,ce=ne,ue=I,he="rate_limiter_flexible";let de=null;const pe=function(e,t,s,r){let i;i=null===r||!0===r||!1===r?r:{remainingPoints:r.remainingPoints,msBeforeNext:r.msBeforeNext,consumedPoints:r.consumedPoints,isFirstInDuration:r.isFirstInDuration},e.send({channel:he,keyPrefix:t.keyPrefix,promiseId:t.promiseId,type:s,data:i})},fe=function(e){setTimeout((()=>{this._initiated?process.send(e):void 0!==this._promises[e.promiseId]&&fe.call(this,e)}),30)},ye=function(e,t,s,r,i){const n={channel:he,keyPrefix:this.keyPrefix,func:e,promiseId:t,data:{key:s,arg:r,opts:i}};this._initiated?process.send(n):fe.call(this,n)},me=function(e,t){if(!t||t.channel!==he||void 0===this._rateLimiters[t.keyPrefix])return!1;let s;switch(t.func){case"consume":s=this._rateLimiters[t.keyPrefix].consume(t.data.key,t.data.arg,t.data.opts);break;case"penalty":s=this._rateLimiters[t.keyPrefix].penalty(t.data.key,t.data.arg,t.data.opts);break;case"reward":s=this._rateLimiters[t.keyPrefix].reward(t.data.key,t.data.arg,t.data.opts);break;case"block":s=this._rateLimiters[t.keyPrefix].block(t.data.key,t.data.arg,t.data.opts);break;case"get":s=this._rateLimiters[t.keyPrefix].get(t.data.key,t.data.opts);break;case"delete":s=this._rateLimiters[t.keyPrefix].delete(t.data.key,t.data.opts);break;default:return!1}s&&s.then((s=>{pe(e,t,"resolve",s)})).catch((s=>{pe(e,t,"reject",s)}))},ge=function(e){if(!e||e.channel!==he||e.keyPrefix!==this.keyPrefix)return!1;if(this._promises[e.promiseId]){let t;switch(clearTimeout(this._promises[e.promiseId].timeoutId),t=null===e.data||!0===e.data||!1===e.data?e.data:new ue(e.data.remainingPoints,e.data.msBeforeNext,e.data.consumedPoints,e.data.isFirstInDuration),e.type){case"resolve":this._promises[e.promiseId].resolve(t);break;case"reject":this._promises[e.promiseId].reject(t);break;default:throw new Error(`RateLimiterCluster: no such message type '${e.type}'`)}delete this._promises[e.promiseId]}},be=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},ke=function(e,t){const s=process.hrtime();let r=s[0].toString()+s[1].toString();return void 0!==this._promises[r]&&(r+=ae.randomBytes(12).toString("base64")),this._promises[r]={resolve:e,reject:t,timeoutId:setTimeout((()=>{delete this._promises[r],t(new Error("RateLimiterCluster timeout: no answer from master in time"))}),this.timeoutMs)},r};var Se={RateLimiterClusterMaster:class{constructor(){if(de)return de;this._rateLimiters={},oe.setMaxListeners(0),oe.on("message",((e,t)=>{t&&t.channel===he&&"init"===t.type?(void 0===this._rateLimiters[t.opts.keyPrefix]&&(this._rateLimiters[t.opts.keyPrefix]=new ce(t.opts)),e.send({channel:he,type:"init",keyPrefix:t.opts.keyPrefix})):me.call(this,e,t)})),de=this}},RateLimiterClusterMasterPM2:class{constructor(e){if(de)return de;this._rateLimiters={},e.launchBus(((t,s)=>{s.on("process:msg",(t=>{const s=t.raw;if(s&&s.channel===he&&"init"===s.type)void 0===this._rateLimiters[s.opts.keyPrefix]&&(this._rateLimiters[s.opts.keyPrefix]=new ce(s.opts)),e.sendDataToProcessId(t.process.pm_id,{data:{},topic:he,channel:he,type:"init",keyPrefix:s.opts.keyPrefix},((e,t)=>{e&&console.log(e,t)}));else{me.call(this,{send:s=>{const r=s;r.topic=he,void 0===r.data&&(r.data={}),e.sendDataToProcessId(t.process.pm_id,r,((e,t)=>{e&&console.log(e,t)}))}},s)}}))})),de=this}},RateLimiterCluster:class extends le{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=void 0===e?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),process.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,process.on("message",(e=>{e&&e.channel===he&&"init"===e.type&&e.keyPrefix===this.keyPrefix?this._initiated=!0:ge.call(this,e)})),process.send({channel:he,type:"init",opts:be.call(this)}),this._promises={}}consume(e,t=1,s={}){return new Promise(((r,i)=>{const n=ke.call(this,r,i);ye.call(this,"consume",n,e,t,s)}))}penalty(e,t=1,s={}){return new Promise(((r,i)=>{const n=ke.call(this,r,i);ye.call(this,"penalty",n,e,t,s)}))}reward(e,t=1,s={}){return new Promise(((r,i)=>{const n=ke.call(this,r,i);ye.call(this,"reward",n,e,t,s)}))}block(e,t,s={}){return new Promise(((r,i)=>{const n=ke.call(this,r,i);ye.call(this,"block",n,e,t,s)}))}get(e,t={}){return new Promise(((s,r)=>{const i=ke.call(this,s,r);ye.call(this,"get",i,e,t)}))}delete(e,t={}){return new Promise(((s,r)=>{const i=ke.call(this,s,r);ye.call(this,"delete",i,e,t)}))}}};const _e=F,we=I;var ve=class extends _e{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,s){const r=new we;return r.consumedPoints=parseInt(s.consumedPoints),r.isFirstInDuration=s.consumedPoints===t,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=s.msBeforeNext,r}_upsert(e,t,s,r=!1,i={}){return new Promise(((n,o)=>{const a=Date.now(),l=Math.floor(s/1e3);r?this.client.set(e,t,l,(s=>{s?o(s):this.client.set(`${e}_expire`,l>0?a+1e3*l:-1,l,(()=>{n({consumedPoints:t,msBeforeNext:l>0?1e3*l:-1})}))})):this.client.incr(e,t,((c,u)=>{c||!1===u?this.client.add(e,t,l,((c,u)=>{if(c||!u)if(void 0===i.attemptNumber||i.attemptNumber<3){const a=Object.assign({},i);a.attemptNumber=a.attemptNumber?a.attemptNumber+1:1,this._upsert(e,t,s,r,a).then((e=>n(e))).catch((e=>o(e)))}else o(new Error("Can not add key"));else this.client.add(`${e}_expire`,l>0?a+1e3*l:-1,l,(()=>{n({consumedPoints:t,msBeforeNext:l>0?1e3*l:-1})}))})):this.client.get(`${e}_expire`,((e,t)=>{if(e)o(e);else{const e=!1===t?0:t,s={consumedPoints:u,msBeforeNext:e>=0?Math.max(e-a,0):-1};n(s)}}))}))}))}_get(e){return new Promise(((t,s)=>{const r=Date.now();this.client.get(e,((i,n)=>{n?this.client.get(`${e}_expire`,((e,i)=>{if(e)s(e);else{const e=!1===i?0:i,s={consumedPoints:n,msBeforeNext:e>=0?Math.max(e-r,0):-1};t(s)}})):t(null)}))}))}_delete(e){return new Promise(((t,s)=>{this.client.del(e,((r,i)=>{r?s(r):!1===i?t(i):this.client.del(`${e}_expire`,(e=>{e?s(e):t(i)}))}))}))}};const Ee=I;const Ce=P;const xe=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}},Ae=4294967295,Te="limiter";class Re{constructor(e,t={maxQueueSize:Ae,key:Te}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then((e=>null!==e?e.remainingPoints:this._limiterFlexible.points))}removeTokens(e){const t=this;return new Promise(((s,r)=>{e>t._limiterFlexible.points?r(new xe(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`)):t._queue.length>0?t._queueRequest.call(t,s,r,e):t._limiterFlexible.consume(t._key,e).then((e=>{s(e.remainingPoints)})).catch((i=>{i instanceof Error?r(i):(t._queueRequest.call(t,s,r,e),null===t._waitTimeout&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),i.msBeforeNext)))}))}))}_queueRequest(e,t,s){const r=this;r._queue.length<r._maxQueueSize?r._queue.push({resolve:e,reject:t,tokens:s}):t(new xe(`Number of requests reached it's maximum ${r._maxQueueSize}`))}_processFIFO(){const e=this;if(null!==e._waitTimeout&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),0===e._queue.length)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then((s=>{t.resolve(s.remainingPoints),e._processFIFO.call(e)})).catch((s=>{s instanceof Error?(t.reject(s),e._processFIFO.call(e)):(e._queue.unshift(t),null===e._waitTimeout&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),s.msBeforeNext)))}))}}const Me=I;const Oe=I,Pe=F;class Be{constructor(e,t,s){this.key=e,this.points=t,this.expire=s}}var Ne=class extends Pe{constructor(e,t=null){super(e),this.client=e.storeClient,this.tableName=e.tableName,this.tableCreated=e.tableCreated,this.tableCreated?this._setTTL().finally((()=>{"function"==typeof t&&t()})):this._createTable(e.dynamoTableOpts).then((e=>{this.tableCreated=!0,this._setTTL().finally((()=>{"function"==typeof t&&t()}))})).catch((e=>{if("function"!=typeof t)throw e;t(e)}))}get tableName(){return this._tableName}set tableName(e){this._tableName=void 0===e?"node-rate-limiter-flexible":e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=void 0!==e&&!!e}async _createTable(e){const t={TableName:this.tableName,AttributeDefinitions:[{AttributeName:"key",AttributeType:"S"}],KeySchema:[{AttributeName:"key",KeyType:"HASH"}],ProvisionedThroughput:{ReadCapacityUnits:e&&e.readCapacityUnits?e.readCapacityUnits:25,WriteCapacityUnits:e&&e.writeCapacityUnits?e.writeCapacityUnits:25}};try{return await this.client.createTable(t)}catch(e){if(e.__type&&e.__type.includes("ResourceInUseException"))return null;throw e}}async _get(e){if(!this.tableCreated)throw new Error("Table is not created yet");const t={TableName:this.tableName,Key:{key:{S:e}}},s=await this.client.getItem(t);return s.Item?new Be(s.Item.key.S,Number(s.Item.points.N),Number(s.Item.expire.N)):null}async _delete(e){if(!this.tableCreated)throw new Error("Table is not created yet");const t={TableName:this.tableName,Key:{key:{S:e}},ConditionExpression:"attribute_exists(#k)",ExpressionAttributeNames:{"#k":"key"}};try{return 200===(await this._client.deleteItem(t)).$metadata.httpStatusCode}catch(e){if(e.__type&&e.__type.includes("ConditionalCheckFailedException"))return!1;throw e}}async _upsert(e,t,s,r=!1,i={}){if(!this.tableCreated)throw new Error("Table is not created yet");const n=Date.now(),o=n/1e3,a=s>0?(n+s)/1e3:-1;if(r)return await this._baseUpsert({TableName:this.tableName,Key:{key:{S:e}},UpdateExpression:"SET points = :points, expire = :expire",ExpressionAttributeValues:{":points":{N:t.toString()},":expire":{N:a.toString()}},ReturnValues:"ALL_NEW"});try{return await this._baseUpsert({TableName:this.tableName,Key:{key:{S:e}},UpdateExpression:"SET points = :new_points, expire = :new_expire",ExpressionAttributeValues:{":new_points":{N:t.toString()},":new_expire":{N:a.toString()},":where_expire":{N:o.toString()}},ConditionExpression:"expire <= :where_expire OR attribute_not_exists(points)",ReturnValues:"ALL_NEW"})}catch(s){return await this._baseUpsert({TableName:this.tableName,Key:{key:{S:e}},UpdateExpression:"SET points = points + :new_points",ExpressionAttributeValues:{":new_points":{N:t.toString()},":where_expire":{N:o.toString()}},ConditionExpression:"expire > :where_expire",ReturnValues:"ALL_NEW"})}}async _baseUpsert(e){if(!this.tableCreated)throw new Error("Table is not created yet");try{const t=await this.client.updateItem(e);return new Be(t.Attributes.key.S,Number(t.Attributes.points.N),Number(t.Attributes.expire.N))}catch(e){throw e}}async _setTTL(){if(!this.tableCreated)throw new Error("Table is not created yet");try{if(await this._isTTLSet())return;const e={TableName:this.tableName,TimeToLiveSpecification:{AttributeName:"expire",Enabled:!0}};return await this.client.updateTimeToLive(e)}catch(e){throw e}}async _isTTLSet(){if(!this.tableCreated)throw new Error("Table is not created yet");try{const e=await this.client.describeTimeToLive({TableName:this.tableName});return 200==e.$metadata.httpStatusCode&&"ENABLED"===e.TimeToLiveDescription.TimeToLiveStatus&&"expire"===e.TimeToLiveDescription.AttributeName}catch(e){throw e}}_getRateLimiterRes(e,t,s){const r=new Oe;return r.isFirstInDuration=t===s.points,r.consumedPoints=r.isFirstInDuration?t:s.points,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=-1!=s.expire?Math.max(1e3*s.expire-Date.now(),0):-1,r}};const Ie=F,De=I;var Le=class extends Ie{constructor(e){if(super(e),this.modelName=e.tableName||"RateLimiterFlexible",this.prismaClient=e.storeClient,this.clearExpiredByTimeout=e.clearExpiredByTimeout||!0,!this.prismaClient)throw new Error("Prisma client is not provided");this.clearExpiredByTimeout&&this._clearExpiredHourAgo()}_getRateLimiterRes(e,t,s){const r=new De;let i=s;return r.isFirstInDuration=i.points===t,r.consumedPoints=i.points,r.remainingPoints=Math.max(this.points-r.consumedPoints,0),r.msBeforeNext=null!==i.expire?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,r}_upsert(e,t,s,r=!1){if(!this.prismaClient)return Promise.reject(new Error("Prisma client is not established"));const i=new Date,n=s>0?new Date(i.getTime()+s):null;return this.prismaClient.$transaction((async s=>{const o=await s[this.modelName].findFirst({where:{key:e}});if(o){const a=r||!o.expire||o.expire<=i||null===n;return s[this.modelName].update({where:{key:e},data:{points:a?t:o.points+t,...a&&{expire:n}}})}return s[this.modelName].create({data:{key:e,points:t,expire:n}})}))}_get(e){return this.prismaClient?this.prismaClient[this.modelName].findFirst({where:{AND:[{key:e},{OR:[{expire:{gt:new Date}},{expire:null}]}]}}):Promise.reject(new Error("Prisma client is not established"))}_delete(e){return this.prismaClient?this.prismaClient[this.modelName].deleteMany({where:{key:e}}).then((e=>e.count>0)):Promise.reject(new Error("Prisma client is not established"))}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout((async()=>{await this.prismaClient[this.modelName].deleteMany({where:{expire:{lt:new Date(Date.now()-36e5)}}}),this._clearExpiredHourAgo()}),3e5)}};const je=U,Fe=W,Qe=J,ze=$,{RateLimiterClusterMaster:Ue,RateLimiterClusterMasterPM2:Ge,RateLimiterCluster:Ke}=Se;var qe={RateLimiterRedis:je,RateLimiterMongo:Fe,RateLimiterMySQL:Qe,RateLimiterPostgres:ze,RateLimiterMemory:ne,RateLimiterMemcache:ve,RateLimiterClusterMaster:Ue,RateLimiterClusterMasterPM2:Ge,RateLimiterCluster:Ke,RLWrapperBlackAndWhite:class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(void 0===e)throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=void 0!==e&&e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(void 0===e&&(e=()=>!1),"function"!=typeof e)throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(void 0===e&&(e=()=>!1),"function"!=typeof e)throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new Ee(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new Ee(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let s;return this.isWhiteListedSomewhere(e)?s=this.resolveWhite():this.isBlackListedSomewhere(e)&&(s=this.rejectBlack()),void 0===s?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch((()=>{})),s)}block(e,t){let s;return this.isWhiteListedSomewhere(e)?s=this.resolveWhite():this.isBlackListedSomewhere(e)&&(s=this.resolveBlack()),void 0===s?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch((()=>{})),s)}penalty(e,t){let s;return this.isWhiteListedSomewhere(e)?s=this.resolveWhite():this.isBlackListedSomewhere(e)&&(s=this.resolveBlack()),void 0===s?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch((()=>{})),s)}reward(e,t){let s;return this.isWhiteListedSomewhere(e)?s=this.resolveWhite():this.isBlackListedSomewhere(e)&&(s=this.resolveBlack()),void 0===s?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch((()=>{})),s)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),void 0===t||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}},RateLimiterUnion:class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach((e=>{if(!(e instanceof Ce))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")})),this._limiters=e}consume(e,t=1){return new Promise(((s,r)=>{const i=[];this._limiters.forEach((s=>{i.push(s.consume(e,t).catch((e=>({rejected:!0,rej:e}))))})),Promise.all(i).then((e=>{const t={};let i=!1;e.forEach((e=>{!0===e.rejected&&(i=!0)}));for(let s=0;s<e.length;s++)i&&!0===e[s].rejected?t[this._limiters[s].keyPrefix]=e[s].rej:i||(t[this._limiters[s].keyPrefix]=e[s]);i?r(t):s(t)}))}))}},RateLimiterQueue:class{constructor(e,t={maxQueueSize:Ae}){this._queueLimiters={KEY_DEFAULT:new Re(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=Te){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=Te){return this._queueLimiters[t]||(this._queueLimiters[t]=new Re(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}},BurstyRateLimiter:class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new Me(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,s={}){return this._rateLimiter.consume(e,t,s).catch((r=>r instanceof Me?this._burstLimiter.consume(e,t,s).then((e=>Promise.resolve(this._combineRes(r,e)))).catch((e=>e instanceof Me?Promise.reject(this._combineRes(r,e)):Promise.reject(e))):Promise.reject(r)))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then((([e,t])=>this._combineRes(e,t)))}get points(){return this._rateLimiter.points}},RateLimiterRes:I,RateLimiterDynamo:Ne,RateLimiterPrisma:Le},Ye={},We={get exports(){return Ye},set exports(e){Ye=e}},Ve={},He={},Je={acl:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},append:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},asking:{arity:1,flags:["fast"],keyStart:0,keyStop:0,step:0},auth:{arity:-2,flags:["noscript","loading","stale","fast","no_auth","allow_busy"],keyStart:0,keyStop:0,step:0},bgrewriteaof:{arity:1,flags:["admin","noscript","no_async_loading"],keyStart:0,keyStop:0,step:0},bgsave:{arity:-1,flags:["admin","noscript","no_async_loading"],keyStart:0,keyStop:0,step:0},bitcount:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},bitfield:{arity:-2,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},bitfield_ro:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},bitop:{arity:-4,flags:["write","denyoom"],keyStart:2,keyStop:-1,step:1},bitpos:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},blmove:{arity:6,flags:["write","denyoom","noscript","blocking"],keyStart:1,keyStop:2,step:1},blmpop:{arity:-5,flags:["write","blocking","movablekeys"],keyStart:0,keyStop:0,step:0},blpop:{arity:-3,flags:["write","noscript","blocking"],keyStart:1,keyStop:-2,step:1},brpop:{arity:-3,flags:["write","noscript","blocking"],keyStart:1,keyStop:-2,step:1},brpoplpush:{arity:4,flags:["write","denyoom","noscript","blocking"],keyStart:1,keyStop:2,step:1},bzmpop:{arity:-5,flags:["write","blocking","movablekeys"],keyStart:0,keyStop:0,step:0},bzpopmax:{arity:-3,flags:["write","noscript","blocking","fast"],keyStart:1,keyStop:-2,step:1},bzpopmin:{arity:-3,flags:["write","noscript","blocking","fast"],keyStart:1,keyStop:-2,step:1},client:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},cluster:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},command:{arity:-1,flags:["loading","stale"],keyStart:0,keyStop:0,step:0},config:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},copy:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},dbsize:{arity:1,flags:["readonly","fast"],keyStart:0,keyStop:0,step:0},debug:{arity:-2,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},decr:{arity:2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},decrby:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},del:{arity:-2,flags:["write"],keyStart:1,keyStop:-1,step:1},discard:{arity:1,flags:["noscript","loading","stale","fast","allow_busy"],keyStart:0,keyStop:0,step:0},dump:{arity:2,flags:["readonly"],keyStart:1,keyStop:1,step:1},echo:{arity:2,flags:["fast"],keyStart:0,keyStop:0,step:0},eval:{arity:-3,flags:["noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},eval_ro:{arity:-3,flags:["readonly","noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},evalsha:{arity:-3,flags:["noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},evalsha_ro:{arity:-3,flags:["readonly","noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},exec:{arity:1,flags:["noscript","loading","stale","skip_slowlog"],keyStart:0,keyStop:0,step:0},exists:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},expire:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},expireat:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},expiretime:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},failover:{arity:-1,flags:["admin","noscript","stale"],keyStart:0,keyStop:0,step:0},fcall:{arity:-3,flags:["noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},fcall_ro:{arity:-3,flags:["readonly","noscript","stale","skip_monitor","no_mandatory_keys","movablekeys"],keyStart:0,keyStop:0,step:0},flushall:{arity:-1,flags:["write"],keyStart:0,keyStop:0,step:0},flushdb:{arity:-1,flags:["write"],keyStart:0,keyStop:0,step:0},function:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},geoadd:{arity:-5,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},geodist:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},geohash:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},geopos:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},georadius:{arity:-6,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},georadius_ro:{arity:-6,flags:["readonly"],keyStart:1,keyStop:1,step:1},georadiusbymember:{arity:-5,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},georadiusbymember_ro:{arity:-5,flags:["readonly"],keyStart:1,keyStop:1,step:1},geosearch:{arity:-7,flags:["readonly"],keyStart:1,keyStop:1,step:1},geosearchstore:{arity:-8,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},get:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},getbit:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},getdel:{arity:2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},getex:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},getrange:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},getset:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hdel:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},hello:{arity:-1,flags:["noscript","loading","stale","fast","no_auth","allow_busy"],keyStart:0,keyStop:0,step:0},hexists:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hget:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hgetall:{arity:2,flags:["readonly"],keyStart:1,keyStop:1,step:1},hincrby:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hincrbyfloat:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hkeys:{arity:2,flags:["readonly"],keyStart:1,keyStop:1,step:1},hlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hmget:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hmset:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hrandfield:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},hscan:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},hset:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hsetnx:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hstrlen:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hvals:{arity:2,flags:["readonly"],keyStart:1,keyStop:1,step:1},incr:{arity:2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},incrby:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},incrbyfloat:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},info:{arity:-1,flags:["loading","stale"],keyStart:0,keyStop:0,step:0},keys:{arity:2,flags:["readonly"],keyStart:0,keyStop:0,step:0},lastsave:{arity:1,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},latency:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},lcs:{arity:-3,flags:["readonly"],keyStart:1,keyStop:2,step:1},lindex:{arity:3,flags:["readonly"],keyStart:1,keyStop:1,step:1},linsert:{arity:5,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},llen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},lmove:{arity:5,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},lmpop:{arity:-4,flags:["write","movablekeys"],keyStart:0,keyStop:0,step:0},lolwut:{arity:-1,flags:["readonly","fast"],keyStart:0,keyStop:0,step:0},lpop:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},lpos:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},lpush:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},lpushx:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},lrange:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},lrem:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},lset:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},ltrim:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},memory:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},mget:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},migrate:{arity:-6,flags:["write","movablekeys"],keyStart:3,keyStop:3,step:1},module:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},monitor:{arity:1,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},move:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},mset:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:2},msetnx:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:2},multi:{arity:1,flags:["noscript","loading","stale","fast","allow_busy"],keyStart:0,keyStop:0,step:0},object:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},persist:{arity:2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pexpire:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pexpireat:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pexpiretime:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},pfadd:{arity:-2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},pfcount:{arity:-2,flags:["readonly"],keyStart:1,keyStop:-1,step:1},pfdebug:{arity:3,flags:["write","denyoom","admin"],keyStart:2,keyStop:2,step:1},pfmerge:{arity:-2,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},pfselftest:{arity:1,flags:["admin"],keyStart:0,keyStop:0,step:0},ping:{arity:-1,flags:["fast"],keyStart:0,keyStop:0,step:0},psetex:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},psubscribe:{arity:-2,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},psync:{arity:-3,flags:["admin","noscript","no_async_loading","no_multi"],keyStart:0,keyStop:0,step:0},pttl:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},publish:{arity:3,flags:["pubsub","loading","stale","fast"],keyStart:0,keyStop:0,step:0},pubsub:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},punsubscribe:{arity:-1,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},quit:{arity:-1,flags:["noscript","loading","stale","fast","no_auth","allow_busy"],keyStart:0,keyStop:0,step:0},randomkey:{arity:1,flags:["readonly"],keyStart:0,keyStop:0,step:0},readonly:{arity:1,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},readwrite:{arity:1,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},rename:{arity:3,flags:["write"],keyStart:1,keyStop:2,step:1},renamenx:{arity:3,flags:["write","fast"],keyStart:1,keyStop:2,step:1},replconf:{arity:-1,flags:["admin","noscript","loading","stale","allow_busy"],keyStart:0,keyStop:0,step:0},replicaof:{arity:3,flags:["admin","noscript","stale","no_async_loading"],keyStart:0,keyStop:0,step:0},reset:{arity:1,flags:["noscript","loading","stale","fast","no_auth","allow_busy"],keyStart:0,keyStop:0,step:0},restore:{arity:-4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},"restore-asking":{arity:-4,flags:["write","denyoom","asking"],keyStart:1,keyStop:1,step:1},role:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},rpop:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},rpoplpush:{arity:3,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},rpush:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},rpushx:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},sadd:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},save:{arity:1,flags:["admin","noscript","no_async_loading","no_multi"],keyStart:0,keyStop:0,step:0},scan:{arity:-2,flags:["readonly"],keyStart:0,keyStop:0,step:0},scard:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},script:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},sdiff:{arity:-2,flags:["readonly"],keyStart:1,keyStop:-1,step:1},sdiffstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},select:{arity:2,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},set:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setbit:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setex:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setnx:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},setrange:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},shutdown:{arity:-1,flags:["admin","noscript","loading","stale","no_multi","allow_busy"],keyStart:0,keyStop:0,step:0},sinter:{arity:-2,flags:["readonly"],keyStart:1,keyStop:-1,step:1},sintercard:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},sinterstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},sismember:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},slaveof:{arity:3,flags:["admin","noscript","stale","no_async_loading"],keyStart:0,keyStop:0,step:0},slowlog:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},smembers:{arity:2,flags:["readonly"],keyStart:1,keyStop:1,step:1},smismember:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},smove:{arity:4,flags:["write","fast"],keyStart:1,keyStop:2,step:1},sort:{arity:-2,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},sort_ro:{arity:-2,flags:["readonly","movablekeys"],keyStart:1,keyStop:1,step:1},spop:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},spublish:{arity:3,flags:["pubsub","loading","stale","fast"],keyStart:1,keyStop:1,step:1},srandmember:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},srem:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},sscan:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},ssubscribe:{arity:-2,flags:["pubsub","noscript","loading","stale"],keyStart:1,keyStop:-1,step:1},strlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},subscribe:{arity:-2,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},substr:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},sunion:{arity:-2,flags:["readonly"],keyStart:1,keyStop:-1,step:1},sunionstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},sunsubscribe:{arity:-1,flags:["pubsub","noscript","loading","stale"],keyStart:1,keyStop:-1,step:1},swapdb:{arity:3,flags:["write","fast"],keyStart:0,keyStop:0,step:0},sync:{arity:1,flags:["admin","noscript","no_async_loading","no_multi"],keyStart:0,keyStop:0,step:0},time:{arity:1,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},touch:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},ttl:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},type:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},unlink:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:-1,step:1},unsubscribe:{arity:-1,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},unwatch:{arity:1,flags:["noscript","loading","stale","fast","allow_busy"],keyStart:0,keyStop:0,step:0},wait:{arity:3,flags:["noscript"],keyStart:0,keyStop:0,step:0},watch:{arity:-2,flags:["noscript","loading","stale","fast","allow_busy"],keyStart:1,keyStop:-1,step:1},xack:{arity:-4,flags:["write","fast"],keyStart:1,keyStop:1,step:1},xadd:{arity:-5,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},xautoclaim:{arity:-6,flags:["write","fast"],keyStart:1,keyStop:1,step:1},xclaim:{arity:-6,flags:["write","fast"],keyStart:1,keyStop:1,step:1},xdel:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},xgroup:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},xinfo:{arity:-2,flags:[],keyStart:0,keyStop:0,step:0},xlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},xpending:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},xrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},xread:{arity:-4,flags:["readonly","blocking","movablekeys"],keyStart:0,keyStop:0,step:0},xreadgroup:{arity:-7,flags:["write","blocking","movablekeys"],keyStart:0,keyStop:0,step:0},xrevrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},xsetid:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},xtrim:{arity:-4,flags:["write"],keyStart:1,keyStop:1,step:1},zadd:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},zcard:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zcount:{arity:4,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zdiff:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zdiffstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},zincrby:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},zinter:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zintercard:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zinterstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},zlexcount:{arity:4,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zmpop:{arity:-4,flags:["write","movablekeys"],keyStart:0,keyStop:0,step:0},zmscore:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zpopmax:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zpopmin:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zrandmember:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangebylex:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangebyscore:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangestore:{arity:-5,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},zrank:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zrem:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zremrangebylex:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zremrangebyrank:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zremrangebyscore:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zrevrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrangebylex:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrangebyscore:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrank:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zscan:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},zscore:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zunion:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zunionstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1}};!function(e){var t=M&&M.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.getKeyIndexes=e.hasFlag=e.exists=e.list=void 0;const s=t(Je);e.list=Object.keys(s.default);const r={};function i(e){"string"!=typeof e&&(e=String(e));const t=e.indexOf("->");return-1===t?e.length:t}e.list.forEach((e=>{r[e]=s.default[e].flags.reduce((function(e,t){return e[t]=!0,e}),{})})),e.exists=function(e){return Boolean(s.default[e])},e.hasFlag=function(e,t){if(!r[e])throw new Error("Unknown command "+e);return Boolean(r[e][t])},e.getKeyIndexes=function(e,t,r){const n=s.default[e];if(!n)throw new Error("Unknown command "+e);if(!Array.isArray(t))throw new Error("Expect args to be an array");const o=[],a=Boolean(r&&r.parseExternalKey),l=(e,t)=>{const s=[],r=Number(e[t]);for(let e=0;e<r;e++)s.push(e+t+1);return s},c=(e,t,s)=>{for(let r=t;r<e.length-1;r+=1)if(String(e[r]).toLowerCase()===s.toLowerCase())return r+1;return null};switch(e){case"zunionstore":case"zinterstore":case"zdiffstore":o.push(0,...l(t,1));break;case"eval":case"evalsha":case"eval_ro":case"evalsha_ro":case"fcall":case"fcall_ro":case"blmpop":case"bzmpop":o.push(...l(t,1));break;case"sintercard":case"lmpop":case"zunion":case"zinter":case"zmpop":case"zintercard":case"zdiff":o.push(...l(t,0));break;case"georadius":{o.push(0);const e=c(t,5,"STORE");e&&o.push(e);const s=c(t,5,"STOREDIST");s&&o.push(s);break}case"georadiusbymember":{o.push(0);const e=c(t,4,"STORE");e&&o.push(e);const s=c(t,4,"STOREDIST");s&&o.push(s);break}case"sort":case"sort_ro":o.push(0);for(let e=1;e<t.length-1;e++){let s=t[e];if("string"!=typeof s)continue;const r=s.toUpperCase();"GET"===r?(e+=1,s=t[e],"#"!==s&&(a?o.push([e,i(s)]):o.push(e))):"BY"===r?(e+=1,a?o.push([e,i(t[e])]):o.push(e)):"STORE"===r&&(e+=1,o.push(e))}break;case"migrate":if(""===t[2])for(let e=5;e<t.length-1;e++){const s=t[e];if("string"==typeof s&&"KEYS"===s.toUpperCase()){for(let s=e+1;s<t.length;s++)o.push(s);break}}else o.push(2);break;case"xreadgroup":case"xread":for(let s="xread"===e?0:3;s<t.length-1;s++)if("STREAMS"===String(t[s]).toUpperCase()){for(let e=s+1;e<=s+(t.length-1-s)/2;e++)o.push(e);break}break;default:if(n.step>0){const e=n.keyStart-1,s=n.keyStop>0?n.keyStop:t.length+n.keyStop+1;for(let t=e;t<s;t+=n.step)o.push(t)}}return o}}(He);var Xe={},Ze={};!function(e){let t;function s(s,r){try{const e=t;return t=null,e.apply(this,arguments)}catch(t){return e.errorObj.e=t,e.errorObj}}Object.defineProperty(e,"__esModule",{value:!0}),e.tryCatch=e.errorObj=void 0,e.errorObj={e:{}},e.tryCatch=function(e){return t=e,s}}(Ze),Object.defineProperty(Xe,"__esModule",{value:!0});const $e=Ze;function et(e){setTimeout((function(){throw e}),0)}Xe.default=function(e,t,s){return"function"==typeof t&&e.then((e=>{let r;r=void 0!==s&&Object(s).spread&&Array.isArray(e)?$e.tryCatch(t).apply(void 0,[null].concat(e)):void 0===e?$e.tryCatch(t)(null):$e.tryCatch(t)(null,e),r===$e.errorObj&&et(r.e)}),(e=>{if(!e){const t=new Error(e+"");Object.assign(t,{cause:e}),e=t}const s=$e.tryCatch(t)(e);s===$e.errorObj&&et(s.e)})),e};var tt,st,rt,it,nt={};const ot=process.version.charCodeAt(1)<55&&46===process.version.charCodeAt(2)?function(){if(st)return tt;st=1;const e=k.default,t=S.default;function s(e){Object.defineProperty(this,"message",{value:e||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}function r(t,s,r){e(s),e.strictEqual(typeof r,"number"),Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0});const i=Error.stackTraceLimit;Error.stackTraceLimit=2,Error.captureStackTrace(this,this.constructor),Error.stackTraceLimit=i,this.offset=r,this.buffer=s}function i(e){Object.defineProperty(this,"message",{value:e||"",configurable:!0,writable:!0});const t=Error.stackTraceLimit;Error.stackTraceLimit=2,Error.captureStackTrace(this,this.constructor),Error.stackTraceLimit=t}function n(e){Object.defineProperty(this,"message",{value:e||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}function o(e){Object.defineProperty(this,"message",{value:e||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}return t.inherits(s,Error),Object.defineProperty(s.prototype,"name",{value:"RedisError",configurable:!0,writable:!0}),t.inherits(r,s),Object.defineProperty(r.prototype,"name",{value:"ParserError",configurable:!0,writable:!0}),t.inherits(i,s),Object.defineProperty(i.prototype,"name",{value:"ReplyError",configurable:!0,writable:!0}),t.inherits(n,s),Object.defineProperty(n.prototype,"name",{value:"AbortError",configurable:!0,writable:!0}),t.inherits(o,n),Object.defineProperty(o.prototype,"name",{value:"InterruptError",configurable:!0,writable:!0}),tt={RedisError:s,ParserError:r,ReplyError:i,AbortError:n,InterruptError:o}}():function(){if(it)return rt;it=1;const e=k.default;class t extends Error{get name(){return this.constructor.name}}class s extends t{get name(){return this.constructor.name}}return rt={RedisError:t,ParserError:class extends t{constructor(t,s,r){e(s),e.strictEqual(typeof r,"number");const i=Error.stackTraceLimit;Error.stackTraceLimit=2,super(t),Error.stackTraceLimit=i,this.offset=r,this.buffer=s}get name(){return this.constructor.name}},ReplyError:class extends t{constructor(e){const t=Error.stackTraceLimit;Error.stackTraceLimit=2,super(e),Error.stackTraceLimit=t}get name(){return this.constructor.name}},AbortError:s,InterruptError:class extends s{get name(){return this.constructor.name}}}}();var at=ot,lt={},ct={},ut=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],ht={get exports(){return ct},set exports(e){ct=e}}.exports=function(e){for(var t,s=0,r=-1,i=0,n=0,o="string"==typeof e?function(e){for(var t,s=0,r=0,i=[],n=e.length;s<n;s++)(t=e.charCodeAt(s))<128?i[r++]=t:t<2048?(i[r++]=t>>6|192,i[r++]=63&t|128):55296==(64512&t)&&s+1<e.length&&56320==(64512&e.charCodeAt(s+1))?(t=65536+((1023&t)<<10)+(1023&e.charCodeAt(++s)),i[r++]=t>>18|240,i[r++]=t>>12&63|128,i[r++]=t>>6&63|128,i[r++]=63&t|128):(i[r++]=t>>12|224,i[r++]=t>>6&63|128,i[r++]=63&t|128);return i}(e):e,a=o.length;s<a;){if(t=o[s++],-1===r)123===t&&(r=s);else if(125!==t)n=ut[255&(t^n>>8)]^n<<8;else if(s-1!==r)return 16383&n;i=ut[255&(t^i>>8)]^i<<8}return 16383&i};ct.generateMulti=function(e){for(var t=1,s=e.length,r=ht(e[0]);t<s;)if(ht(e[t++])!==r)return-1;return r};var dt={},pt={},ft=9007199254740991,yt="[object Arguments]",mt="[object Function]",gt="[object GeneratorFunction]",bt=/^(?:0|[1-9]\d*)$/;function kt(e,t,s){switch(s.length){case 0:return e.call(t);case 1:return e.call(t,s[0]);case 2:return e.call(t,s[0],s[1]);case 3:return e.call(t,s[0],s[1],s[2])}return e.apply(t,s)}var St=Object.prototype,_t=St.hasOwnProperty,wt=St.toString,vt=St.propertyIsEnumerable,Et=Math.max;function Ct(e,t){var s=Pt(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Bt(e)}(e)&&_t.call(e,"callee")&&(!vt.call(e,"callee")||wt.call(e)==yt)}(e)?function(e,t){for(var s=-1,r=Array(e);++s<e;)r[s]=t(s);return r}(e.length,String):[],r=s.length,i=!!r;for(var n in e)!t&&!_t.call(e,n)||i&&("length"==n||Mt(n,r))||s.push(n);return s}function xt(e,t,s,r){return void 0===e||Ot(e,St[s])&&!_t.call(r,s)?t:e}function At(e,t,s){var r=e[t];_t.call(e,t)&&Ot(r,s)&&(void 0!==s||t in e)||(e[t]=s)}function Tt(e){if(!Nt(e))return function(e){var t=[];if(null!=e)for(var s in Object(e))t.push(s);return t}(e);var t,s,r,i=(s=(t=e)&&t.constructor,r="function"==typeof s&&s.prototype||St,t===r),n=[];for(var o in e)("constructor"!=o||!i&&_t.call(e,o))&&n.push(o);return n}function Rt(e,t){return t=Et(void 0===t?e.length-1:t,0),function(){for(var s=arguments,r=-1,i=Et(s.length-t,0),n=Array(i);++r<i;)n[r]=s[t+r];r=-1;for(var o=Array(t+1);++r<t;)o[r]=s[r];return o[t]=n,kt(e,this,o)}}function Mt(e,t){return!!(t=null==t?ft:t)&&("number"==typeof e||bt.test(e))&&e>-1&&e%1==0&&e<t}function Ot(e,t){return e===t||e!=e&&t!=t}var Pt=Array.isArray;function Bt(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=ft}(e.length)&&!function(e){var t=Nt(e)?wt.call(e):"";return t==mt||t==gt}(e)}function Nt(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var It,Dt=(It=function(e,t,s,r){!function(e,t,s,r){s||(s={});for(var i=-1,n=t.length;++i<n;){var o=t[i],a=r?r(s[o],e[o],o,s,e):void 0;At(s,o,void 0===a?e[o]:a)}}(t,function(e){return Bt(e)?Ct(e,!0):Tt(e)}(t),e,r)},Rt((function(e,t){var s=-1,r=t.length,i=r>1?t[r-1]:void 0,n=r>2?t[2]:void 0;for(i=It.length>3&&"function"==typeof i?(r--,i):void 0,n&&function(e,t,s){if(!Nt(s))return!1;var r=typeof t;return!!("number"==r?Bt(s)&&Mt(t,s.length):"string"==r&&t in s)&&Ot(s[t],e)}(t[0],t[1],n)&&(i=r<3?void 0:i,r=1),e=Object(e);++s<r;){var o=t[s];o&&It(e,o,s,i)}return e})));var Lt=Rt((function(e){return e.push(void 0,xt),kt(Dt,void 0,e)})),jt=9007199254740991,Ft="[object Function]",Qt="[object GeneratorFunction]",zt=Object.prototype,Ut=zt.hasOwnProperty,Gt=zt.toString,Kt=zt.propertyIsEnumerable;var qt=function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&function(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=jt}(e.length)&&!function(e){var t=function(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}(e)?Gt.call(e):"";return t==Ft||t==Qt}(e)}(e)}(e)&&Ut.call(e,"callee")&&(!Kt.call(e,"callee")||"[object Arguments]"==Gt.call(e))};Object.defineProperty(pt,"__esModule",{value:!0}),pt.isArguments=pt.defaults=pt.noop=void 0;const Yt=Lt;pt.defaults=Yt;const Wt=qt;pt.isArguments=Wt,pt.noop=function(){};var Vt,Ht,Jt,Xt,Zt,$t={},es={},ts={get exports(){return es},set exports(e){es=e}},ss={},rs={get exports(){return ss},set exports(e){ss=e}};function is(){if(Ht)return Vt;Ht=1;var e=1e3,t=60*e,s=60*t,r=24*s,i=7*r,n=365.25*r;function o(e,t,s,r){var i=t>=1.5*s;return Math.round(e/s)+" "+r+(i?"s":"")}return Vt=function(a,l){l=l||{};var c=typeof a;if("string"===c&&a.length>0)return function(o){if((o=String(o)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(o);if(!a)return;var l=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*i;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*s;case"minutes":case"minute":case"mins":case"min":case"m":return l*t;case"seconds":case"second":case"secs":case"sec":case"s":return l*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}(a);if("number"===c&&isFinite(a))return l.long?function(i){var n=Math.abs(i);if(n>=r)return o(i,n,r,"day");if(n>=s)return o(i,n,s,"hour");if(n>=t)return o(i,n,t,"minute");if(n>=e)return o(i,n,e,"second");return i+" ms"}(a):function(i){var n=Math.abs(i);if(n>=r)return Math.round(i/r)+"d";if(n>=s)return Math.round(i/s)+"h";if(n>=t)return Math.round(i/t)+"m";if(n>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))},Vt}function ns(){if(Xt)return Jt;return Xt=1,Jt=function(e){function t(e){let r,i,n,o=null;function a(...e){if(!a.enabled)return;const s=a,i=Number(new Date),n=i-(r||i);s.diff=n,s.prev=r,s.curr=i,r=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((r,i)=>{if("%%"===r)return"%";o++;const n=t.formatters[i];if("function"==typeof n){const t=e[o];r=n.call(s,t),e.splice(o,1),o--}return r})),t.formatArgs.call(s,e);(s.log||t.log).apply(s,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=s,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,n=t.enabled(e)),n),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function s(e,s){const r=t(this.namespace+(void 0===s?":":s)+e);return r.log=this.log,r}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(r),...t.skips.map(r).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let s;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),i=r.length;for(s=0;s<i;s++)r[s]&&("-"===(e=r[s].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let s,r;for(s=0,r=t.skips.length;s<r;s++)if(t.skips[s].test(e))return!1;for(s=0,r=t.names.length;s<r;s++)if(t.names[s].test(e))return!0;return!1},t.humanize=is(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((s=>{t[s]=e[s]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let s=0;for(let t=0;t<e.length;t++)s=(s<<5)-s+e.charCodeAt(t),s|=0;return t.colors[Math.abs(s)%t.colors.length]},t.enable(t.load()),t},Jt}var os,as,ls,cs,us,hs={},ds={get exports(){return hs},set exports(e){hs=e}};function ps(){return as?os:(as=1,os=(e,t=process.argv)=>{const s=e.startsWith("-")?"":1===e.length?"-":"--",r=t.indexOf(s+e),i=t.indexOf("--");return-1!==r&&(-1===i||r<i)})}function fs(){return us||(us=1,function(e,t){const s=w.default,r=S.default;t.init=function(e){e.inspectOpts={};const s=Object.keys(t.inspectOpts);for(let r=0;r<s.length;r++)e.inspectOpts[s[r]]=t.inspectOpts[s[r]]},t.log=function(...e){return process.stderr.write(r.formatWithOptions(t.inspectOpts,...e)+"\n")},t.formatArgs=function(s){const{namespace:r,useColors:i}=this;if(i){const t=this.color,i="[3"+(t<8?t:"8;5;"+t),n=`  ${i};1m${r} [0m`;s[0]=n+s[0].split("\n").join("\n"+n),s.push(i+"m+"+e.exports.humanize(this.diff)+"[0m")}else s[0]=function(){if(t.inspectOpts.hideDate)return"";return(new Date).toISOString()+" "}()+r+" "+s[0]},t.save=function(e){e?process.env.DEBUG=e:delete process.env.DEBUG},t.load=function(){return process.env.DEBUG},t.useColors=function(){return"colors"in t.inspectOpts?Boolean(t.inspectOpts.colors):s.isatty(process.stderr.fd)},t.destroy=r.deprecate((()=>{}),"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."),t.colors=[6,2,3,4,5,1];try{const e=function(){if(cs)return ls;cs=1;const e=v.default,t=w.default,s=ps(),{env:r}=process;let i;function n(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function o(t,n){if(0===i)return 0;if(s("color=16m")||s("color=full")||s("color=truecolor"))return 3;if(s("color=256"))return 2;if(t&&!n&&void 0===i)return 0;const o=i||0;if("dumb"===r.TERM)return o;if("win32"===process.platform){const t=e.release().split(".");return Number(t[0])>=10&&Number(t[2])>=10586?Number(t[2])>=14931?3:2:1}if("CI"in r)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some((e=>e in r))||"codeship"===r.CI_NAME?1:o;if("TEAMCITY_VERSION"in r)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(r.TEAMCITY_VERSION)?1:0;if("truecolor"===r.COLORTERM)return 3;if("TERM_PROGRAM"in r){const e=parseInt((r.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(r.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(r.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(r.TERM)||"COLORTERM"in r?1:o}return s("no-color")||s("no-colors")||s("color=false")||s("color=never")?i=0:(s("color")||s("colors")||s("color=true")||s("color=always"))&&(i=1),"FORCE_COLOR"in r&&(i="true"===r.FORCE_COLOR?1:"false"===r.FORCE_COLOR?0:0===r.FORCE_COLOR.length?1:Math.min(parseInt(r.FORCE_COLOR,10),3)),ls={supportsColor:function(e){return n(o(e,e&&e.isTTY))},stdout:n(o(!0,t.isatty(1))),stderr:n(o(!0,t.isatty(2)))}}();e&&(e.stderr||e).level>=2&&(t.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(e){}t.inspectOpts=Object.keys(process.env).filter((e=>/^debug_/i.test(e))).reduce(((e,t)=>{const s=t.substring(6).toLowerCase().replace(/_([a-z])/g,((e,t)=>t.toUpperCase()));let r=process.env[t];return r=!!/^(yes|on|true|enabled)$/i.test(r)||!/^(no|off|false|disabled)$/i.test(r)&&("null"===r?null:Number(r)),e[s]=r,e}),{}),e.exports=ns()(t);const{formatters:i}=e.exports;i.o=function(e){return this.inspectOpts.colors=this.useColors,r.inspect(e,this.inspectOpts).split("\n").map((e=>e.trim())).join(" ")},i.O=function(e){return this.inspectOpts.colors=this.useColors,r.inspect(e,this.inspectOpts)}}(ds,hs)),hs}!function(e){"undefined"==typeof process||"renderer"===process.type||!0===process.browser||process.__nwjs?e.exports=(Zt||(Zt=1,function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;t.splice(1,0,s,"color: inherit");let r=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(i=r))})),t.splice(i,0,s)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=ns()(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(rs,ss)),ss):e.exports=fs()}(ts),Object.defineProperty($t,"__esModule",{value:!0}),$t.genRedactedString=$t.getStringValue=$t.MAX_ARGUMENT_LENGTH=void 0;const ys=es;$t.MAX_ARGUMENT_LENGTH=200;function ms(e){if(null!==e)switch(typeof e){case"boolean":case"number":return;case"object":if(Buffer.isBuffer(e))return e.toString("hex");if(Array.isArray(e))return e.join(",");try{return JSON.stringify(e)}catch(e){return}case"string":return e}}function gs(e,t){const{length:s}=e;return s<=t?e:e.slice(0,t)+' ... <REDACTED full-length="'+s+'">'}$t.getStringValue=ms,$t.genRedactedString=gs,$t.default=function(e){const t=(0,ys.default)(`ioredis:${e}`);function s(...e){if(t.enabled){for(let t=1;t<e.length;t++){const s=ms(e[t]);"string"==typeof s&&s.length>200&&(e[t]=gs(s,200))}return t.apply(null,e)}}return Object.defineProperties(s,{namespace:{get:()=>t.namespace},enabled:{get:()=>t.enabled},destroy:{get:()=>t.destroy},log:{get:()=>t.log,set(e){t.log=e}}}),s};var bs={};Object.defineProperty(bs,"__esModule",{value:!0});const ks="-----BEGIN CERTIFICATE-----\nMIIDTzCCAjegAwIBAgIJAKSVpiDswLcwMA0GCSqGSIb3DQEBBQUAMD4xFjAUBgNV\nBAoMDUdhcmFudGlhIERhdGExJDAiBgNVBAMMG1NTTCBDZXJ0aWZpY2F0aW9uIEF1\ndGhvcml0eTAeFw0xMzEwMDExMjE0NTVaFw0yMzA5MjkxMjE0NTVaMD4xFjAUBgNV\nBAoMDUdhcmFudGlhIERhdGExJDAiBgNVBAMMG1NTTCBDZXJ0aWZpY2F0aW9uIEF1\ndGhvcml0eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALZqkh/DczWP\nJnxnHLQ7QL0T4B4CDKWBKCcisriGbA6ZePWVNo4hfKQC6JrzfR+081NeD6VcWUiz\nrmd+jtPhIY4c+WVQYm5PKaN6DT1imYdxQw7aqO5j2KUCEh/cznpLxeSHoTxlR34E\nQwF28Wl3eg2vc5ct8LjU3eozWVk3gb7alx9mSA2SgmuX5lEQawl++rSjsBStemY2\nBDwOpAMXIrdEyP/cVn8mkvi/BDs5M5G+09j0gfhyCzRWMQ7Hn71u1eolRxwVxgi3\nTMn+/vTaFSqxKjgck6zuAYjBRPaHe7qLxHNr1So/Mc9nPy+3wHebFwbIcnUojwbp\n4nctkWbjb2cCAwEAAaNQME4wHQYDVR0OBBYEFP1whtcrydmW3ZJeuSoKZIKjze3w\nMB8GA1UdIwQYMBaAFP1whtcrydmW3ZJeuSoKZIKjze3wMAwGA1UdEwQFMAMBAf8w\nDQYJKoZIhvcNAQEFBQADggEBAG2erXhwRAa7+ZOBs0B6X57Hwyd1R4kfmXcs0rta\nlbPpvgULSiB+TCbf3EbhJnHGyvdCY1tvlffLjdA7HJ0PCOn+YYLBA0pTU/dyvrN6\nSu8NuS5yubnt9mb13nDGYo1rnt0YRfxN+8DM3fXIVr038A30UlPX2Ou1ExFJT0MZ\nuFKY6ZvLdI6/1cbgmguMlAhM+DhKyV6Sr5699LM3zqeI816pZmlREETYkGr91q7k\nBpXJu/dtHaGxg1ZGu6w/PCsYGUcECWENYD4VQPd8N32JjOfu6vEgoEAwfPP+3oGp\nZ4m3ewACcWOAenqflb+cQYC4PsF7qbXDmRaWrbKntOlZ3n0=\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIGMTCCBBmgAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwajELMAkGA1UEBhMCVVMx\nCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJDQTESMBAGA1UECgwJUmVkaXNMYWJzMS0w\nKwYDVQQDDCRSZWRpc0xhYnMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHhcN\nMTgwMjI1MTUzNzM3WhcNMjgwMjIzMTUzNzM3WjBfMQswCQYDVQQGEwJVUzELMAkG\nA1UECAwCQ0ExEjAQBgNVBAoMCVJlZGlzTGFiczEvMC0GA1UEAwwmUkNQIEludGVy\nbWVkaWF0ZSBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwggIiMA0GCSqGSIb3DQEBAQUA\nA4ICDwAwggIKAoICAQDf9dqbxc8Bq7Ctq9rWcxrGNKKHivqLAFpPq02yLPx6fsOv\nTq7GsDChAYBBc4v7Y2Ap9RD5Vs3dIhEANcnolf27QwrG9RMnnvzk8pCvp1o6zSU4\nVuOE1W66/O1/7e2rVxyrnTcP7UgK43zNIXu7+tiAqWsO92uSnuMoGPGpeaUm1jym\nhjWKtkAwDFSqvHY+XL5qDVBEjeUe+WHkYUg40cAXjusAqgm2hZt29c2wnVrxW25W\nP0meNlzHGFdA2AC5z54iRiqj57dTfBTkHoBczQxcyw6hhzxZQ4e5I5zOKjXXEhZN\nr0tA3YC14CTabKRus/JmZieyZzRgEy2oti64tmLYTqSlAD78pRL40VNoaSYetXLw\nhhNsXCHgWaY6d5bLOc/aIQMAV5oLvZQKvuXAF1IDmhPA+bZbpWipp0zagf1P1H3s\nUzsMdn2KM0ejzgotbtNlj5TcrVwpmvE3ktvUAuA+hi3FkVx1US+2Gsp5x4YOzJ7u\nP1WPk6ShF0JgnJH2ILdj6kttTWwFzH17keSFICWDfH/+kM+k7Y1v3EXMQXE7y0T9\nMjvJskz6d/nv+sQhY04xt64xFMGTnZjlJMzfQNi7zWFLTZnDD0lPowq7l3YiPoTT\nt5Xky83lu0KZsZBo0WlWaDG00gLVdtRgVbcuSWxpi5BdLb1kRab66JptWjxwXQID\nAQABo4HrMIHoMDoGA1UdHwQzMDEwL6AtoCuGKWh0dHBzOi8vcmwtY2Etc2VydmVy\nLnJlZGlzbGFicy5jb20vdjEvY3JsMEYGCCsGAQUFBwEBBDowODA2BggrBgEFBQcw\nAYYqaHR0cHM6Ly9ybC1jYS1zZXJ2ZXIucmVkaXNsYWJzLmNvbS92MS9vY3NwMB0G\nA1UdDgQWBBQHar5OKvQUpP2qWt6mckzToeCOHDAfBgNVHSMEGDAWgBQi42wH6hM4\nL2sujEvLM0/u8lRXTzASBgNVHRMBAf8ECDAGAQH/AgEAMA4GA1UdDwEB/wQEAwIB\nhjANBgkqhkiG9w0BAQsFAAOCAgEAirEn/iTsAKyhd+pu2W3Z5NjCko4NPU0EYUbr\nAP7+POK2rzjIrJO3nFYQ/LLuC7KCXG+2qwan2SAOGmqWst13Y+WHp44Kae0kaChW\nvcYLXXSoGQGC8QuFSNUdaeg3RbMDYFT04dOkqufeWVccoHVxyTSg9eD8LZuHn5jw\n7QDLiEECBmIJHk5Eeo2TAZrx4Yx6ufSUX5HeVjlAzqwtAqdt99uCJ/EL8bgpWbe+\nXoSpvUv0SEC1I1dCAhCKAvRlIOA6VBcmzg5Am12KzkqTul12/VEFIgzqu0Zy2Jbc\nAUPrYVu/+tOGXQaijy7YgwH8P8n3s7ZeUa1VABJHcxrxYduDDJBLZi+MjheUDaZ1\njQRHYevI2tlqeSBqdPKG4zBY5lS0GiAlmuze5oENt0P3XboHoZPHiqcK3VECgTVh\n/BkJcuudETSJcZDmQ8YfoKfBzRQNg2sv/hwvUv73Ss51Sco8GEt2lD8uEdib1Q6z\nzDT5lXJowSzOD5ZA9OGDjnSRL+2riNtKWKEqvtEG3VBJoBzu9GoxbAc7wIZLxmli\niF5a/Zf5X+UXD3s4TMmy6C4QZJpAA2egsSQCnraWO2ULhh7iXMysSkF/nzVfZn43\niqpaB8++9a37hWq14ZmOv0TJIDz//b2+KC4VFXWQ5W5QC6whsjT+OlG4p5ZYG0jo\n616pxqo=\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIFujCCA6KgAwIBAgIJAJ1aTT1lu2ScMA0GCSqGSIb3DQEBCwUAMGoxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTELMAkGA1UEBwwCQ0ExEjAQBgNVBAoMCVJlZGlz\nTGFiczEtMCsGA1UEAwwkUmVkaXNMYWJzIFJvb3QgQ2VydGlmaWNhdGUgQXV0aG9y\naXR5MB4XDTE4MDIyNTE1MjA0MloXDTM4MDIyMDE1MjA0MlowajELMAkGA1UEBhMC\nVVMxCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJDQTESMBAGA1UECgwJUmVkaXNMYWJz\nMS0wKwYDVQQDDCRSZWRpc0xhYnMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkw\nggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDLEjXy7YrbN5Waau5cd6g1\nG5C2tMmeTpZ0duFAPxNU4oE3RHS5gGiok346fUXuUxbZ6QkuzeN2/2Z+RmRcJhQY\nDm0ZgdG4x59An1TJfnzKKoWj8ISmoHS/TGNBdFzXV7FYNLBuqZouqePI6ReC6Qhl\npp45huV32Q3a6IDrrvx7Wo5ZczEQeFNbCeCOQYNDdTmCyEkHqc2AGo8eoIlSTutT\nULOC7R5gzJVTS0e1hesQ7jmqHjbO+VQS1NAL4/5K6cuTEqUl+XhVhPdLWBXJQ5ag\n54qhX4v+ojLzeU1R/Vc6NjMvVtptWY6JihpgplprN0Yh2556ewcXMeturcKgXfGJ\nxeYzsjzXerEjrVocX5V8BNrg64NlifzTMKNOOv4fVZszq1SIHR8F9ROrqiOdh8iC\nJpUbLpXH9hWCSEO6VRMB2xJoKu3cgl63kF30s77x7wLFMEHiwsQRKxooE1UhgS9K\n2sO4TlQ1eWUvFvHSTVDQDlGQ6zu4qjbOpb3Q8bQwoK+ai2alkXVR4Ltxe9QlgYK3\nStsnPhruzZGA0wbXdpw0bnM+YdlEm5ffSTpNIfgHeaa7Dtb801FtA71ZlH7A6TaI\nSIQuUST9EKmv7xrJyx0W1pGoPOLw5T029aTjnICSLdtV9bLwysrLhIYG5bnPq78B\ncS+jZHFGzD7PUVGQD01nOQIDAQABo2MwYTAdBgNVHQ4EFgQUIuNsB+oTOC9rLoxL\nyzNP7vJUV08wHwYDVR0jBBgwFoAUIuNsB+oTOC9rLoxLyzNP7vJUV08wDwYDVR0T\nAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAYYwDQYJKoZIhvcNAQELBQADggIBAHfg\nz5pMNUAKdMzK1aS1EDdK9yKz4qicILz5czSLj1mC7HKDRy8cVADUxEICis++CsCu\nrYOvyCVergHQLREcxPq4rc5Nq1uj6J6649NEeh4WazOOjL4ZfQ1jVznMbGy+fJm3\n3Hoelv6jWRG9iqeJZja7/1s6YC6bWymI/OY1e4wUKeNHAo+Vger7MlHV+RuabaX+\nhSJ8bJAM59NCM7AgMTQpJCncrcdLeceYniGy5Q/qt2b5mJkQVkIdy4TPGGB+AXDJ\nD0q3I/JDRkDUFNFdeW0js7fHdsvCR7O3tJy5zIgEV/o/BCkmJVtuwPYOrw/yOlKj\nTY/U7ATAx9VFF6/vYEOMYSmrZlFX+98L6nJtwDqfLB5VTltqZ4H/KBxGE3IRSt9l\nFXy40U+LnXzhhW+7VBAvyYX8GEXhHkKU8Gqk1xitrqfBXY74xKgyUSTolFSfFVgj\nmcM/X4K45bka+qpkj7Kfv/8D4j6aZekwhN2ly6hhC1SmQ8qjMjpG/mrWOSSHZFmf\nybu9iD2AYHeIOkshIl6xYIa++Q/00/vs46IzAbQyriOi0XxlSMMVtPx0Q3isp+ji\nn8Mq9eOuxYOEQ4of8twUkUDd528iwGtEdwf0Q01UyT84S62N8AySl1ZBKXJz6W4F\nUhWfa/HQYOAPDdEjNgnVwLI23b8t0TozyCWw7q8h\n-----END CERTIFICATE-----\n\n-----BEGIN CERTIFICATE-----\nMIIEjzCCA3egAwIBAgIQe55B/ALCKJDZtdNT8kD6hTANBgkqhkiG9w0BAQsFADBM\nMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMzETMBEGA1UEChMKR2xv\nYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjAeFw0yMjAxMjYxMjAwMDBaFw0y\nNTAxMjYwMDAwMDBaMFgxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9iYWxTaWdu\nIG52LXNhMS4wLAYDVQQDEyVHbG9iYWxTaWduIEF0bGFzIFIzIE9WIFRMUyBDQSAy\nMDIyIFEyMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAmGmg1LW9b7Lf\n8zDD83yBDTEkt+FOxKJZqF4veWc5KZsQj9HfnUS2e5nj/E+JImlGPsQuoiosLuXD\nBVBNAMcUFa11buFMGMeEMwiTmCXoXRrXQmH0qjpOfKgYc5gHG3BsRGaRrf7VR4eg\nofNMG9wUBw4/g/TT7+bQJdA4NfE7Y4d5gEryZiBGB/swaX6Jp/8MF4TgUmOWmalK\ndZCKyb4sPGQFRTtElk67F7vU+wdGcrcOx1tDcIB0ncjLPMnaFicagl+daWGsKqTh\ncounQb6QJtYHa91KvCfKWocMxQ7OIbB5UARLPmC4CJ1/f8YFm35ebfzAeULYdGXu\njE9CLor0OwIDAQABo4IBXzCCAVswDgYDVR0PAQH/BAQDAgGGMB0GA1UdJQQWMBQG\nCCsGAQUFBwMBBggrBgEFBQcDAjASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQW\nBBSH5Zq7a7B/t95GfJWkDBpA8HHqdjAfBgNVHSMEGDAWgBSP8Et/qC5FJK5NUPpj\nmove4t0bvDB7BggrBgEFBQcBAQRvMG0wLgYIKwYBBQUHMAGGImh0dHA6Ly9vY3Nw\nMi5nbG9iYWxzaWduLmNvbS9yb290cjMwOwYIKwYBBQUHMAKGL2h0dHA6Ly9zZWN1\ncmUuZ2xvYmFsc2lnbi5jb20vY2FjZXJ0L3Jvb3QtcjMuY3J0MDYGA1UdHwQvMC0w\nK6ApoCeGJWh0dHA6Ly9jcmwuZ2xvYmFsc2lnbi5jb20vcm9vdC1yMy5jcmwwIQYD\nVR0gBBowGDAIBgZngQwBAgIwDAYKKwYBBAGgMgoBAjANBgkqhkiG9w0BAQsFAAOC\nAQEAKRic9/f+nmhQU/wz04APZLjgG5OgsuUOyUEZjKVhNGDwxGTvKhyXGGAMW2B/\n3bRi+aElpXwoxu3pL6fkElbX3B0BeS5LoDtxkyiVEBMZ8m+sXbocwlPyxrPbX6mY\n0rVIvnuUeBH8X0L5IwfpNVvKnBIilTbcebfHyXkPezGwz7E1yhUULjJFm2bt0SdX\ny+4X/WeiiYIv+fTVgZZgl+/2MKIsu/qdBJc3f3TvJ8nz+Eax1zgZmww+RSQWeOj3\n15Iw6Z5FX+NwzY/Ab+9PosR5UosSeq+9HhtaxZttXG1nVh+avYPGYddWmiMT90J5\nZgKnO/Fx2hBgTxhOTMYaD312kg==\n-----END CERTIFICATE-----\n\n-----BEGIN CERTIFICATE-----\nMIIDXzCCAkegAwIBAgILBAAAAAABIVhTCKIwDQYJKoZIhvcNAQELBQAwTDEgMB4G\nA1UECxMXR2xvYmFsU2lnbiBSb290IENBIC0gUjMxEzARBgNVBAoTCkdsb2JhbFNp\nZ24xEzARBgNVBAMTCkdsb2JhbFNpZ24wHhcNMDkwMzE4MTAwMDAwWhcNMjkwMzE4\nMTAwMDAwWjBMMSAwHgYDVQQLExdHbG9iYWxTaWduIFJvb3QgQ0EgLSBSMzETMBEG\nA1UEChMKR2xvYmFsU2lnbjETMBEGA1UEAxMKR2xvYmFsU2lnbjCCASIwDQYJKoZI\nhvcNAQEBBQADggEPADCCAQoCggEBAMwldpB5BngiFvXAg7aEyiie/QV2EcWtiHL8\nRgJDx7KKnQRfJMsuS+FggkbhUqsMgUdwbN1k0ev1LKMPgj0MK66X17YUhhB5uzsT\ngHeMCOFJ0mpiLx9e+pZo34knlTifBtc+ycsmWQ1z3rDI6SYOgxXG71uL0gRgykmm\nKPZpO/bLyCiR5Z2KYVc3rHQU3HTgOu5yLy6c+9C7v/U9AOEGM+iCK65TpjoWc4zd\nQQ4gOsC0p6Hpsk+QLjJg6VfLuQSSaGjlOCZgdbKfd/+RFO+uIEn8rUAVSNECMWEZ\nXriX7613t2Saer9fwRPvm2L7DWzgVGkWqQPabumDk3F2xmmFghcCAwEAAaNCMEAw\nDgYDVR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFI/wS3+o\nLkUkrk1Q+mOai97i3Ru8MA0GCSqGSIb3DQEBCwUAA4IBAQBLQNvAUKr+yAzv95ZU\nRUm7lgAJQayzE4aGKAczymvmdLm6AC2upArT9fHxD4q/c2dKg8dEe3jgr25sbwMp\njjM5RcOO5LlXbKr8EpbsU8Yt5CRsuZRj+9xTaGdWPoO4zzUhw8lo/s7awlOqzJCK\n6fBdRoyV3XpYKBovHd7NADdBj+1EbddTKJd+82cEHhXXipa0095MJ6RMG3NzdvQX\nmcIfeg7jLQitChws/zyrVQ4PkX4268NXSb7hLi18YIvDQVETI53O9zJrlAGomecs\nMx86OyXShkDOOyyGeMlhLxS67ttVb9+E7gUJTb0o2HLO02JQZR7rkpeDMdmztcpH\nWD9f\n-----END CERTIFICATE-----",Ss={RedisCloudFixed:{ca:ks},RedisCloudFlexible:{ca:ks}};bs.default=Ss,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.noop=e.defaults=e.Debug=e.zipMap=e.CONNECTION_CLOSED_ERROR_MSG=e.shuffle=e.sample=e.resolveTLSProfile=e.parseURL=e.optimizeErrorStack=e.toArg=e.convertMapToArray=e.convertObjectToArray=e.timeout=e.packObject=e.isInt=e.wrapMultiResult=e.convertBufferToString=void 0;const t=_.default,s=pt;Object.defineProperty(e,"defaults",{enumerable:!0,get:function(){return s.defaults}}),Object.defineProperty(e,"noop",{enumerable:!0,get:function(){return s.noop}});const r=$t;e.Debug=r.default;const i=bs;function n(e){const t=parseFloat(e);return!isNaN(e)&&(0|t)===t}e.convertBufferToString=function e(t,s){if(t instanceof Buffer)return t.toString(s);if(Array.isArray(t)){const r=t.length,i=Array(r);for(let n=0;n<r;++n)i[n]=t[n]instanceof Buffer&&"utf8"===s?t[n].toString():e(t[n],s);return i}return t},e.wrapMultiResult=function(e){if(!e)return null;const t=[],s=e.length;for(let r=0;r<s;++r){const s=e[r];s instanceof Error?t.push([s]):t.push([null,s])}return t},e.isInt=n,e.packObject=function(e){const t={},s=e.length;for(let r=1;r<s;r+=2)t[e[r-1]]=e[r];return t},e.timeout=function(e,t){let s=null;const r=function(){s&&(clearTimeout(s),s=null,e.apply(this,arguments))};return s=setTimeout(r,t,new Error("timeout")),r},e.convertObjectToArray=function(e){const t=[],s=Object.keys(e);for(let r=0,i=s.length;r<i;r++)t.push(s[r],e[s[r]]);return t},e.convertMapToArray=function(e){const t=[];let s=0;return e.forEach((function(e,r){t[s]=r,t[s+1]=e,s+=2})),t},e.toArg=function(e){return null==e?"":String(e)},e.optimizeErrorStack=function(e,t,s){const r=t.split("\n");let i,n="";for(i=1;i<r.length&&-1!==r[i].indexOf(s);++i);for(let e=i;e<r.length;++e)n+="\n"+r[e];if(e.stack){const t=e.stack.indexOf("\n");e.stack=e.stack.slice(0,t)+n}return e},e.parseURL=function(e){if(n(e))return{port:e};let r=(0,t.parse)(e,!0,!0);r.slashes||"/"===e[0]||(e="//"+e,r=(0,t.parse)(e,!0,!0));const i=r.query||{},o={};if(r.auth){const e=r.auth.indexOf(":");o.username=-1===e?r.auth:r.auth.slice(0,e),o.password=-1===e?"":r.auth.slice(e+1)}if(r.pathname&&("redis:"===r.protocol||"rediss:"===r.protocol?r.pathname.length>1&&(o.db=r.pathname.slice(1)):o.path=r.pathname),r.host&&(o.host=r.hostname),r.port&&(o.port=r.port),"string"==typeof i.family){const e=Number.parseInt(i.family,10);Number.isNaN(e)||(o.family=e)}return(0,s.defaults)(o,i),o},e.resolveTLSProfile=function(e){let t=null==e?void 0:e.tls;"string"==typeof t&&(t={profile:t});const s=i.default[null==t?void 0:t.profile];return s&&(t=Object.assign({},s,t),delete t.profile,e=Object.assign({},e,{tls:t})),e},e.sample=function(e,t=0){const s=e.length;return t>=s?null:e[t+Math.floor(Math.random()*(s-t))]},e.shuffle=function(e){let t=e.length;for(;t>0;){const s=Math.floor(Math.random()*t);t--,[e[t],e[s]]=[e[s],e[t]]}return e},e.CONNECTION_CLOSED_ERROR_MSG="Connection is closed.",e.zipMap=function(e,t){const s=new Map;return e.forEach(((e,r)=>{s.set(e,t[r])})),s}}(dt),Object.defineProperty(lt,"__esModule",{value:!0});const _s=He,ws=ct,vs=Xe,Es=dt;class Cs{constructor(e,t=[],s={},r){if(this.name=e,this.inTransaction=!1,this.isResolved=!1,this.transformed=!1,this.replyEncoding=s.replyEncoding,this.errorStack=s.errorStack,this.args=t.flat(),this.callback=r,this.initPromise(),s.keyPrefix){const e=s.keyPrefix instanceof Buffer;let t=e?s.keyPrefix:null;this._iterateKeys((r=>r instanceof Buffer?(null===t&&(t=Buffer.from(s.keyPrefix)),Buffer.concat([t,r])):e?Buffer.concat([s.keyPrefix,Buffer.from(String(r))]):s.keyPrefix+r))}s.readOnly&&(this.isReadOnly=!0)}static checkFlag(e,t){return!!this.getFlagMap()[e][t]}static setArgumentTransformer(e,t){this._transformer.argument[e]=t}static setReplyTransformer(e,t){this._transformer.reply[e]=t}static getFlagMap(){return this.flagMap||(this.flagMap=Object.keys(Cs.FLAGS).reduce(((e,t)=>(e[t]={},Cs.FLAGS[t].forEach((s=>{e[t][s]=!0})),e)),{})),this.flagMap}getSlot(){if(void 0===this.slot){const e=this.getKeys()[0];this.slot=null==e?null:ws(e)}return this.slot}getKeys(){return this._iterateKeys()}toWritable(e){let t;const s="*"+(this.args.length+1)+"\r\n$"+Buffer.byteLength(this.name)+"\r\n"+this.name+"\r\n";if(this.bufferMode){const e=new Ts;e.push(s);for(let t=0;t<this.args.length;++t){const s=this.args[t];s instanceof Buffer?0===s.length?e.push("$0\r\n\r\n"):(e.push("$"+s.length+"\r\n"),e.push(s),e.push("\r\n")):e.push("$"+Buffer.byteLength(s)+"\r\n"+s+"\r\n")}t=e.toBuffer()}else{t=s;for(let e=0;e<this.args.length;++e){const s=this.args[e];t+="$"+Buffer.byteLength(s)+"\r\n"+s+"\r\n"}}return t}stringifyArguments(){for(let e=0;e<this.args.length;++e){const t=this.args[e];"string"==typeof t||(t instanceof Buffer?this.bufferMode=!0:this.args[e]=(0,Es.toArg)(t))}}transformReply(e){this.replyEncoding&&(e=(0,Es.convertBufferToString)(e,this.replyEncoding));const t=Cs._transformer.reply[this.name];return t&&(e=t(e)),e}setTimeout(e){this._commandTimeoutTimer||(this._commandTimeoutTimer=setTimeout((()=>{this.isResolved||this.reject(new Error("Command timed out"))}),e))}initPromise(){const e=new Promise(((e,t)=>{if(!this.transformed){this.transformed=!0;const e=Cs._transformer.argument[this.name];e&&(this.args=e(this.args)),this.stringifyArguments()}this.resolve=this._convertValue(e),this.errorStack?this.reject=e=>{t((0,Es.optimizeErrorStack)(e,this.errorStack.stack,__dirname))}:this.reject=t}));this.promise=(0,vs.default)(e,this.callback)}_iterateKeys(e=e=>e){if(void 0===this.keys&&(this.keys=[],(0,_s.exists)(this.name))){const t=(0,_s.getKeyIndexes)(this.name,this.args);for(const s of t)this.args[s]=e(this.args[s]),this.keys.push(this.args[s])}return this.keys}_convertValue(e){return t=>{try{const s=this._commandTimeoutTimer;s&&(clearTimeout(s),delete this._commandTimeoutTimer),e(this.transformReply(t)),this.isResolved=!0}catch(e){this.reject(e)}return this.promise}}}lt.default=Cs,Cs.FLAGS={VALID_IN_SUBSCRIBER_MODE:["subscribe","psubscribe","unsubscribe","punsubscribe","ssubscribe","sunsubscribe","ping","quit"],VALID_IN_MONITOR_MODE:["monitor","auth"],ENTER_SUBSCRIBER_MODE:["subscribe","psubscribe","ssubscribe"],EXIT_SUBSCRIBER_MODE:["unsubscribe","punsubscribe","sunsubscribe"],WILL_DISCONNECT:["quit"]},Cs._transformer={argument:{},reply:{}};const xs=function(e){if(1===e.length){if(e[0]instanceof Map)return(0,Es.convertMapToArray)(e[0]);if("object"==typeof e[0]&&null!==e[0])return(0,Es.convertObjectToArray)(e[0])}return e},As=function(e){if(2===e.length){if(e[1]instanceof Map)return[e[0]].concat((0,Es.convertMapToArray)(e[1]));if("object"==typeof e[1]&&null!==e[1])return[e[0]].concat((0,Es.convertObjectToArray)(e[1]))}return e};Cs.setArgumentTransformer("mset",xs),Cs.setArgumentTransformer("msetnx",xs),Cs.setArgumentTransformer("hset",As),Cs.setArgumentTransformer("hmset",As),Cs.setReplyTransformer("hgetall",(function(e){if(Array.isArray(e)){const t={};for(let s=0;s<e.length;s+=2){const r=e[s],i=e[s+1];r in t?Object.defineProperty(t,r,{value:i,configurable:!0,enumerable:!0,writable:!0}):t[r]=i}return t}return e}));class Ts{constructor(){this.length=0,this.items=[]}push(e){this.length+=Buffer.byteLength(e),this.items.push(e)}toBuffer(){const e=Buffer.allocUnsafe(this.length);let t=0;for(const s of this.items){const r=Buffer.byteLength(s);Buffer.isBuffer(s)?s.copy(e,t):e.write(s,t,r),t+=r}return e}}var Rs={};Object.defineProperty(Rs,"__esModule",{value:!0});const Ms=at;class Os extends Ms.RedisError{constructor(e,t){super(e),this.lastNodeError=t,Error.captureStackTrace(this,this.constructor)}get name(){return this.constructor.name}}Rs.default=Os,Os.defaultMessage="Failed to refresh slots cache.";var Ps={};Object.defineProperty(Ps,"__esModule",{value:!0});const Bs=E.default;class Ns extends Bs.Readable{constructor(e){super(e),this.opt=e,this._redisCursor="0",this._redisDrained=!1}_read(){if(this._redisDrained)return void this.push(null);const e=[this._redisCursor];this.opt.key&&e.unshift(this.opt.key),this.opt.match&&e.push("MATCH",this.opt.match),this.opt.type&&e.push("TYPE",this.opt.type),this.opt.count&&e.push("COUNT",String(this.opt.count)),this.opt.redis[this.opt.command](e,((e,t)=>{e?this.emit("error",e):(this._redisCursor=t[0]instanceof Buffer?t[0].toString():t[0],"0"===this._redisCursor&&(this._redisDrained=!0),this.push(t[1]))}))}close(){this._redisDrained=!0}}Ps.default=Ns;var Is={},Ds={},Ls={},js={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.executeWithAutoPipelining=e.getFirstValueInFlattenedArray=e.shouldUseAutoPipelining=e.notAllowedAutoPipelineCommands=e.kCallbacks=e.kExec=void 0;const t=pt,s=ct,r=Xe;function i(t,s){if(t._runningAutoPipelines.has(s))return;if(!t._autoPipelines.has(s))return;t._runningAutoPipelines.add(s);const r=t._autoPipelines.get(s);t._autoPipelines.delete(s);const n=r[e.kCallbacks];r[e.kCallbacks]=null,r.exec((function(e,r){if(t._runningAutoPipelines.delete(s),e)for(let t=0;t<n.length;t++)process.nextTick(n[t],e);else for(let e=0;e<n.length;e++)process.nextTick(n[e],...r[e]);t._autoPipelines.has(s)&&i(t,s)}))}function n(e){for(let s=0;s<e.length;s++){const r=e[s];if("string"==typeof r)return r;if(Array.isArray(r)||(0,t.isArguments)(r)){if(0===r.length)continue;return r[0]}const i=[r].flat();if(i.length>0)return i[0]}}e.kExec=Symbol("exec"),e.kCallbacks=Symbol("callbacks"),e.notAllowedAutoPipelineCommands=["auth","info","script","quit","cluster","pipeline","multi","subscribe","psubscribe","unsubscribe","unpsubscribe","select"],e.shouldUseAutoPipelining=function(t,s,r){return s&&t.options.enableAutoPipelining&&!t.isPipeline&&!e.notAllowedAutoPipelineCommands.includes(r)&&!t.options.autoPipeliningIgnoredCommands.includes(r)},e.getFirstValueInFlattenedArray=n,e.executeWithAutoPipelining=function o(a,l,c,u,h){if(a.isCluster&&!a.slots.length)return"wait"===a.status&&a.connect().catch(t.noop),(0,r.default)(new Promise((function(e,t){a.delayUntilReady((s=>{s?t(s):o(a,l,c,u,null).then(e,t)}))})),h);const d=a.options.keyPrefix||"",p=a.isCluster?a.slots[s(`${d}${n(u)}`)].join(","):"main";if(!a._autoPipelines.has(p)){const t=a.pipeline();t[e.kExec]=!1,t[e.kCallbacks]=[],a._autoPipelines.set(p,t)}const f=a._autoPipelines.get(p);f[e.kExec]||(f[e.kExec]=!0,setImmediate(i,a,p));const y=new Promise((function(t,s){f[e.kCallbacks].push((function(e,r){e?s(e):t(r)})),"call"===l&&u.unshift(c),f[l](...u)}));return(0,r.default)(y,h)}}(js);var Fs={};Object.defineProperty(Fs,"__esModule",{value:!0});const Qs=g.default,zs=lt,Us=Xe;Fs.default=class{constructor(e,t=null,s="",r=!1){this.lua=e,this.numberOfKeys=t,this.keyPrefix=s,this.readOnly=r,this.sha=(0,Qs.createHash)("sha1").update(e).digest("hex");const i=this.sha,n=new WeakSet;this.Command=class extends zs.default{toWritable(t){const s=this.reject;return this.reject=e=>{-1!==e.message.indexOf("NOSCRIPT")&&n.delete(t),s.call(this,e)},n.has(t)?"eval"===this.name&&(this.name="evalsha",this.args[0]=i):(n.add(t),this.name="eval",this.args[0]=e),super.toWritable(t)}}}execute(e,t,s,r){"number"==typeof this.numberOfKeys&&t.unshift(this.numberOfKeys),this.keyPrefix&&(s.keyPrefix=this.keyPrefix),this.readOnly&&(s.readOnly=!0);const i=new this.Command("evalsha",[this.sha,...t],s);return i.promise=i.promise.catch((r=>{if(-1===r.message.indexOf("NOSCRIPT"))throw r;const i=new this.Command("evalsha",[this.sha,...t],s);return(e.isPipeline?e.redis:e).sendCommand(i)})),(0,Us.default)(i.promise,r),e.sendCommand(i)}},Object.defineProperty(Ls,"__esModule",{value:!0});const Gs=He,Ks=js,qs=lt,Ys=Fs;class Ws{constructor(){this.options={},this.scriptsSet={},this.addedBuiltinSet=new Set}getBuiltinCommands(){return Vs.slice(0)}createBuiltinCommand(e){return{string:Hs(null,e,"utf8"),buffer:Hs(null,e,null)}}addBuiltinCommand(e){this.addedBuiltinSet.add(e),this[e]=Hs(e,e,"utf8"),this[e+"Buffer"]=Hs(e+"Buffer",e,null)}defineCommand(e,t){const s=new Ys.default(t.lua,t.numberOfKeys,this.options.keyPrefix,t.readOnly);this.scriptsSet[e]=s,this[e]=Js(e,e,s,"utf8"),this[e+"Buffer"]=Js(e+"Buffer",e,s,null)}sendCommand(e,t,s){throw new Error('"sendCommand" is not implemented')}}const Vs=Gs.list.filter((e=>"monitor"!==e));function Hs(e,t,s){return void 0===s&&(s=t,t=null),function(...r){const i=t||r.shift();let n=r[r.length-1];"function"==typeof n?r.pop():n=void 0;const o={errorStack:this.options.showFriendlyErrorStack?new Error:void 0,keyPrefix:this.options.keyPrefix,replyEncoding:s};return(0,Ks.shouldUseAutoPipelining)(this,e,i)?(0,Ks.executeWithAutoPipelining)(this,e,i,r,n):this.sendCommand(new qs.default(i,r,o,n))}}function Js(e,t,s,r){return function(...i){const n="function"==typeof i[i.length-1]?i.pop():void 0,o={replyEncoding:r};return this.options.showFriendlyErrorStack&&(o.errorStack=new Error),(0,Ks.shouldUseAutoPipelining)(this,e,t)?(0,Ks.executeWithAutoPipelining)(this,e,t,i,n):s.execute(this,i,o,n)}}Vs.push("sentinel"),Vs.forEach((function(e){Ws.prototype[e]=Hs(e,e,"utf8"),Ws.prototype[e+"Buffer"]=Hs(e+"Buffer",e,null)})),Ws.prototype.call=Hs("call","utf8"),Ws.prototype.callBuffer=Hs("callBuffer",null),Ws.prototype.send_command=Ws.prototype.call,Ls.default=Ws,Object.defineProperty(Ds,"__esModule",{value:!0});const Xs=ct,Zs=He,$s=Xe,er=S.default,tr=lt,sr=dt,rr=Ls;class ir extends rr.default{constructor(e){super(),this.redis=e,this.isPipeline=!0,this.replyPending=0,this._queue=[],this._result=[],this._transactions=0,this._shaToScript={},this.isCluster="Cluster"===this.redis.constructor.name||this.redis.isCluster,this.options=e.options,Object.keys(e.scriptsSet).forEach((t=>{const s=e.scriptsSet[t];this._shaToScript[s.sha]=s,this[t]=e[t],this[t+"Buffer"]=e[t+"Buffer"]})),e.addedBuiltinSet.forEach((t=>{this[t]=e[t],this[t+"Buffer"]=e[t+"Buffer"]})),this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}));const t=this;Object.defineProperty(this,"length",{get:function(){return t._queue.length}})}fillResult(e,t){if("exec"===this._queue[t].name&&Array.isArray(e[1])){const s=e[1].length;for(let r=0;r<s;r++){if(e[1][r]instanceof Error)continue;const i=this._queue[t-(s-r)];try{e[1][r]=i.transformReply(e[1][r])}catch(t){e[1][r]=t}}}if(this._result[t]=e,--this.replyPending)return;if(this.isCluster){let e,t=!0;for(let s=0;s<this._result.length;++s){const r=this._result[s][0],i=this._queue[s];if(r){if("exec"===i.name&&"EXECABORT Transaction discarded because of previous errors."===r.message)continue;if(e){if(e.name!==r.name||e.message!==r.message){t=!1;break}}else e={name:r.name,message:r.message}}else if(!i.inTransaction){if(!((0,Zs.exists)(i.name)&&(0,Zs.hasFlag)(i.name,"readonly"))){t=!1;break}}}if(e&&t){const t=this,s=e.message.split(" "),r=this._queue;let i=!1;this._queue=[];for(let e=0;e<r.length;++e){if(!("ASK"!==s[0]||i||"asking"===r[e].name||r[e-1]&&"asking"===r[e-1].name)){const e=new tr.default("asking");e.ignore=!0,this.sendCommand(e)}r[e].initPromise(),this.sendCommand(r[e]),i=r[e].inTransaction}let n=!0;void 0===this.leftRedirections&&(this.leftRedirections={});const o=function(){t.exec()},a=this.redis;if(a.handleError(e,this.leftRedirections,{moved:function(e,r){t.preferKey=r,a.slots[s[1]]=[r],a._groupsBySlot[s[1]]=a._groupsIds[a.slots[s[1]].join(";")],a.refreshSlotsCache(),t.exec()},ask:function(e,s){t.preferKey=s,t.exec()},tryagain:o,clusterDown:o,connectionClosed:o,maxRedirections:()=>{n=!1},defaults:()=>{n=!1}}),n)return}}let s=0;for(let e=0;e<this._queue.length-s;++e)this._queue[e+s].ignore&&(s+=1),this._result[e]=this._result[e+s];this.resolve(this._result.slice(0,this._result.length-s))}sendCommand(e){this._transactions>0&&(e.inTransaction=!0);const t=this._queue.length;return e.pipelineIndex=t,e.promise.then((e=>{this.fillResult([null,e],t)})).catch((e=>{this.fillResult([e],t)})),this._queue.push(e),this}addBatch(e){let t,s,r;for(let i=0;i<e.length;++i)t=e[i],s=t[0],r=t.slice(1),this[s].apply(this,r);return this}}Ds.default=ir;const nr=ir.prototype.multi;ir.prototype.multi=function(){return this._transactions+=1,nr.apply(this,arguments)};const or=ir.prototype.execBuffer;ir.prototype.execBuffer=(0,er.deprecate)((function(){return this._transactions>0&&(this._transactions-=1),or.apply(this,arguments)}),"Pipeline#execBuffer: Use Pipeline#exec instead"),ir.prototype.exec=function(e){if(this.isCluster&&!this.redis.slots.length)return"wait"===this.redis.status&&this.redis.connect().catch(sr.noop),e&&!this.nodeifiedPromise&&(this.nodeifiedPromise=!0,(0,$s.default)(this.promise,e)),this.redis.delayUntilReady((t=>{t?this.reject(t):this.exec(e)})),this.promise;if(this._transactions>0)return this._transactions-=1,or.apply(this,arguments);let t;if(this.nodeifiedPromise||(this.nodeifiedPromise=!0,(0,$s.default)(this.promise,e)),this._queue.length||this.resolve([]),this.isCluster){const e=[];for(let t=0;t<this._queue.length;t++){const s=this._queue[t].getKeys();if(s.length&&e.push(s[0]),s.length&&Xs.generateMulti(s)<0)return this.reject(new Error("All the keys in a pipeline command should belong to the same slot")),this.promise}if(e.length){if(t=function(e,t){const s=Xs(t[0]),r=e._groupsBySlot[s];for(let s=1;s<t.length;s++)if(e._groupsBySlot[Xs(t[s])]!==r)return-1;return s}(this.redis,e),t<0)return this.reject(new Error("All keys in the pipeline should belong to the same slots allocation group")),this.promise}else t=16384*Math.random()|0}const s=this;return function(){let e,r=s.replyPending=s._queue.length;s.isCluster&&(e={slot:t,redis:s.redis.connectionPool.nodes.all[s.preferKey]});let i,n="";const o={isPipeline:!0,destination:s.isCluster?e:{redis:s.redis},write(e){"string"!=typeof e?(i||(i=[]),n&&(i.push(Buffer.from(n,"utf8")),n=""),i.push(e)):n+=e,--r||(i?(n&&i.push(Buffer.from(n,"utf8")),o.destination.redis.stream.write(Buffer.concat(i))):o.destination.redis.stream.write(n),r=s._queue.length,n="",i=void 0)}};for(let t=0;t<s._queue.length;++t)s.redis.sendCommand(s._queue[t],o,e);s.promise}(),this.promise},Object.defineProperty(Is,"__esModule",{value:!0}),Is.addTransactionSupport=void 0;const ar=dt,lr=Xe,cr=Ds;Is.addTransactionSupport=function(e){e.pipeline=function(e){const t=new cr.default(this);return Array.isArray(e)&&t.addBatch(e),t};const{multi:t}=e;e.multi=function(e,s){if(void 0!==s||Array.isArray(e)||(s=e,e=null),s&&!1===s.pipeline)return t.call(this);const r=new cr.default(this);r.multi(),Array.isArray(e)&&r.addBatch(e);const i=r.exec;r.exec=function(e){if(this.isCluster&&!this.redis.slots.length)return"wait"===this.redis.status&&this.redis.connect().catch(ar.noop),(0,lr.default)(new Promise(((e,t)=>{this.redis.delayUntilReady((s=>{s?t(s):this.exec(r).then(e,t)}))})),e);if(this._transactions>0&&i.call(r),this.nodeifiedPromise)return i.call(r);const t=i.call(r);return(0,lr.default)(t.then((function(e){const t=e[e.length-1];if(void 0===t)throw new Error("Pipeline cannot be used to send any commands when the `exec()` has been called on it.");if(t[0]){t[0].previousErrors=[];for(let s=0;s<e.length-1;++s)e[s][0]&&t[0].previousErrors.push(e[s][0]);throw t[0]}return(0,ar.wrapMultiResult)(t[1])})),e)};const{execBuffer:n}=r;return r.execBuffer=function(e){return this._transactions>0&&n.call(r),r.exec(e)},r};const{exec:s}=e;e.exec=function(e){return(0,lr.default)(s.call(this).then((function(e){return Array.isArray(e)&&(e=(0,ar.wrapMultiResult)(e)),e})),e)}};var ur={};Object.defineProperty(ur,"__esModule",{value:!0}),ur.default=function(e,t){Object.getOwnPropertyNames(t.prototype).forEach((s=>{Object.defineProperty(e.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s))}))};var hr={};Object.defineProperty(hr,"__esModule",{value:!0}),hr.DEFAULT_CLUSTER_OPTIONS=void 0;const dr=C.default;hr.DEFAULT_CLUSTER_OPTIONS={clusterRetryStrategy:e=>Math.min(100+2*e,2e3),enableOfflineQueue:!0,enableReadyCheck:!0,scaleReads:"master",maxRedirections:16,retryDelayOnMoved:0,retryDelayOnFailover:100,retryDelayOnClusterDown:100,retryDelayOnTryAgain:100,slotsRefreshTimeout:1e3,useSRVRecords:!1,resolveSrv:dr.resolveSrv,dnsLookup:dr.lookup,enableAutoPipelining:!1,autoPipeliningIgnoredCommands:[]};var pr={},fr={};Object.defineProperty(fr,"__esModule",{value:!0}),fr.getConnectionName=fr.weightSrvRecords=fr.groupSrvRecords=fr.getUniqueHostnamesFromOptions=fr.normalizeNodeOptions=fr.nodeKeyToRedisOptions=fr.getNodeKey=void 0;const yr=dt,mr=x.default;var gr;fr.getNodeKey=function(e){return e.port=e.port||6379,e.host=e.host||"127.0.0.1",e.host+":"+e.port},fr.nodeKeyToRedisOptions=function(e){const t=e.lastIndexOf(":");if(-1===t)throw new Error(`Invalid node key ${e}`);return{host:e.slice(0,t),port:Number(e.slice(t+1))}},fr.normalizeNodeOptions=function(e){return e.map((e=>{const t={};if("object"==typeof e)Object.assign(t,e);else if("string"==typeof e)Object.assign(t,(0,yr.parseURL)(e));else{if("number"!=typeof e)throw new Error("Invalid argument "+e);t.port=e}return"string"==typeof t.port&&(t.port=parseInt(t.port,10)),delete t.db,t.port||(t.port=6379),t.host||(t.host="127.0.0.1"),(0,yr.resolveTLSProfile)(t)}))},fr.getUniqueHostnamesFromOptions=function(e){const t={};return e.forEach((e=>{t[e.host]=!0})),Object.keys(t).filter((e=>!(0,mr.isIP)(e)))},fr.groupSrvRecords=function(e){const t={};for(const s of e)t.hasOwnProperty(s.priority)?(t[s.priority].totalWeight+=s.weight,t[s.priority].records.push(s)):t[s.priority]={totalWeight:s.weight,records:[s]};return t},fr.weightSrvRecords=function(e){if(1===e.records.length)return e.totalWeight=0,e.records.shift();const t=Math.floor(Math.random()*(e.totalWeight+e.records.length));let s=0;for(const[r,i]of e.records.entries())if(s+=1+i.weight,s>t)return e.totalWeight-=i.weight,e.records.splice(r,1),i},fr.getConnectionName=function(e,t){const s=`ioredis-cluster(${e})`;return t?`${s}:${t}`:s};var br,kr={};var Sr={};function _r(e,t){t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(e)?this._fromArray(e):(this._capacityMask=3,this._list=new Array(4))}_r.prototype.peekAt=function(e){var t=e;if(t===(0|t)){var s=this.size();if(!(t>=s||t<-s))return t<0&&(t+=s),t=this._head+t&this._capacityMask,this._list[t]}},_r.prototype.get=function(e){return this.peekAt(e)},_r.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},_r.prototype.peekFront=function(){return this.peek()},_r.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(_r.prototype,"length",{get:function(){return this.size()}}),_r.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},_r.prototype.unshift=function(e){if(0===arguments.length)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},_r.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}},_r.prototype.push=function(e){if(0===arguments.length)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},_r.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var s=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),s}},_r.prototype.removeOne=function(e){var t=e;if(t===(0|t)&&this._head!==this._tail){var s=this.size(),r=this._list.length;if(!(t>=s||t<-s)){t<0&&(t+=s),t=this._head+t&this._capacityMask;var i,n=this._list[t];if(e<s/2){for(i=e;i>0;i--)this._list[t]=this._list[t=t-1+r&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+r&this._capacityMask}else{for(i=s-1-e;i>0;i--)this._list[t]=this._list[t=t+1+r&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+r&this._capacityMask}return n}}},_r.prototype.remove=function(e,t){var s,r=e,i=t;if(r===(0|r)&&this._head!==this._tail){var n=this.size(),o=this._list.length;if(!(r>=n||r<-n||t<1)){if(r<0&&(r+=n),1===t||!t)return(s=new Array(1))[0]=this.removeOne(r),s;if(0===r&&r+t>=n)return s=this.toArray(),this.clear(),s;var a;for(r+t>n&&(t=n-r),s=new Array(t),a=0;a<t;a++)s[a]=this._list[this._head+r+a&this._capacityMask];if(r=this._head+r&this._capacityMask,e+t===n){for(this._tail=this._tail-t+o&this._capacityMask,a=t;a>0;a--)this._list[r=r+1+o&this._capacityMask]=void 0;return s}if(0===e){for(this._head=this._head+t+o&this._capacityMask,a=t-1;a>0;a--)this._list[r=r+1+o&this._capacityMask]=void 0;return s}if(r<n/2){for(this._head=this._head+e+t+o&this._capacityMask,a=e;a>0;a--)this.unshift(this._list[r=r-1+o&this._capacityMask]);for(r=this._head-1+o&this._capacityMask;i>0;)this._list[r=r-1+o&this._capacityMask]=void 0,i--;e<0&&(this._tail=r)}else{for(this._tail=r,r=r+t+o&this._capacityMask,a=n-(t+e);a>0;a--)this.push(this._list[r++]);for(r=this._tail;i>0;)this._list[r=r+1+o&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=o>>>2&&this._shrinkArray(),s}}},_r.prototype.splice=function(e,t){var s=e;if(s===(0|s)){var r=this.size();if(s<0&&(s+=r),!(s>r)){if(arguments.length>2){var i,n,o,a=arguments.length,l=this._list.length,c=2;if(!r||s<r/2){for(n=new Array(s),i=0;i<s;i++)n[i]=this._list[this._head+i&this._capacityMask];for(0===t?(o=[],s>0&&(this._head=this._head+s+l&this._capacityMask)):(o=this.remove(s,t),this._head=this._head+s+l&this._capacityMask);a>c;)this.unshift(arguments[--a]);for(i=s;i>0;i--)this.unshift(n[i-1])}else{var u=(n=new Array(r-(s+t))).length;for(i=0;i<u;i++)n[i]=this._list[this._head+s+t+i&this._capacityMask];for(0===t?(o=[],s!=r&&(this._tail=this._head+s+l&this._capacityMask)):(o=this.remove(s,t),this._tail=this._tail-u+l&this._capacityMask);c<a;)this.push(arguments[c++]);for(i=0;i<u;i++)this.push(n[i])}return o}return this.remove(s,t)}}},_r.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},_r.prototype.isEmpty=function(){return this._head===this._tail},_r.prototype.toArray=function(){return this._copyArray(!1)},_r.prototype._fromArray=function(e){var t=e.length,s=this._nextPowerOf2(t);this._list=new Array(s),this._capacityMask=s-1,this._tail=t;for(var r=0;r<t;r++)this._list[r]=e[r]},_r.prototype._copyArray=function(e,t){var s=this._list,r=s.length,i=this.length;if((t|=i)==i&&this._head<this._tail)return this._list.slice(this._head,this._tail);var n,o=new Array(t),a=0;if(e||this._head>this._tail){for(n=this._head;n<r;n++)o[a++]=s[n];for(n=0;n<this._tail;n++)o[a++]=s[n]}else for(n=this._head;n<this._tail;n++)o[a++]=s[n];return o},_r.prototype._growArray=function(){if(0!=this._head){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},_r.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},_r.prototype._nextPowerOf2=function(e){var t=1<<Math.log(e)/Math.log(2)+1;return Math.max(t,4)};var wr=_r;Object.defineProperty(Sr,"__esModule",{value:!0});const vr=wr,Er=(0,dt.Debug)("delayqueue");var Cr;function xr(){if(Cr)return nt;Cr=1,Object.defineProperty(nt,"__esModule",{value:!0});const e=He,t=b.default,s=at,r=Xe,i=lt,n=Rs,o=Ri(),a=Ps,l=Is,c=dt,u=ur,h=Ls,d=hr,p=function(){if(gr)return pr;gr=1,Object.defineProperty(pr,"__esModule",{value:!0});const e=fr,t=dt,s=Ri(),r=(0,t.Debug)("cluster:subscriber");return pr.default=class{constructor(t,s){this.connectionPool=t,this.emitter=s,this.started=!1,this.subscriber=null,this.onSubscriberEnd=()=>{this.started?(r("subscriber has disconnected, selecting a new one..."),this.selectSubscriber()):r("subscriber has disconnected, but ClusterSubscriber is not started, so not reconnecting.")},this.connectionPool.on("-node",((t,s)=>{this.started&&this.subscriber&&(0,e.getNodeKey)(this.subscriber.options)===s&&(r("subscriber has left, selecting a new one..."),this.selectSubscriber())})),this.connectionPool.on("+node",(()=>{this.started&&!this.subscriber&&(r("a new node is discovered and there is no subscriber, selecting a new one..."),this.selectSubscriber())}))}getInstance(){return this.subscriber}start(){this.started=!0,this.selectSubscriber(),r("started")}stop(){this.started=!1,this.subscriber&&(this.subscriber.disconnect(),this.subscriber=null),r("stopped")}selectSubscriber(){const i=this.lastActiveSubscriber;i&&(i.off("end",this.onSubscriberEnd),i.disconnect()),this.subscriber&&(this.subscriber.off("end",this.onSubscriberEnd),this.subscriber.disconnect());const n=(0,t.sample)(this.connectionPool.getNodes());if(!n)return r("selecting subscriber failed since there is no node discovered in the cluster yet"),void(this.subscriber=null);const{options:o}=n;r("selected a subscriber %s:%s",o.host,o.port),this.subscriber=new s.default({port:o.port,host:o.host,username:o.username,password:o.password,enableReadyCheck:!0,connectionName:(0,e.getConnectionName)("subscriber",o.connectionName),lazyConnect:!0,tls:o.tls,retryStrategy:null}),this.subscriber.on("error",t.noop),this.subscriber.once("end",this.onSubscriberEnd);const a={subscribe:[],psubscribe:[],ssubscribe:[]};if(i){const e=i.condition||i.prevCondition;e&&e.subscriber&&(a.subscribe=e.subscriber.channels("subscribe"),a.psubscribe=e.subscriber.channels("psubscribe"),a.ssubscribe=e.subscriber.channels("ssubscribe"))}if(a.subscribe.length||a.psubscribe.length||a.ssubscribe.length){let e=0;for(const t of["subscribe","psubscribe","ssubscribe"]){const s=a[t];s.length&&(e+=1,r("%s %d channels",t,s.length),this.subscriber[t](s).then((()=>{--e||(this.lastActiveSubscriber=this.subscriber)})).catch((()=>{r("failed to %s %d channels",t,s.length)})))}}else this.lastActiveSubscriber=this.subscriber;for(const e of["message","messageBuffer","smessage","smessageBuffer"])this.subscriber.on(e,((t,s)=>{this.emitter.emit(e,t,s)}));for(const e of["pmessage","pmessageBuffer"])this.subscriber.on(e,((t,s,r)=>{this.emitter.emit(e,t,s,r)}))}},pr}(),f=function(){if(br)return kr;br=1,Object.defineProperty(kr,"__esModule",{value:!0});const e=b.default,t=dt,s=fr,r=Ri(),i=(0,t.Debug)("cluster:connectionPool");class n extends e.EventEmitter{constructor(e){super(),this.redisOptions=e,this.nodes={all:{},master:{},slave:{}},this.specifiedOptions={}}getNodes(e="all"){const t=this.nodes[e];return Object.keys(t).map((e=>t[e]))}getInstanceByKey(e){return this.nodes.all[e]}getSampleInstance(e){const s=Object.keys(this.nodes[e]),r=(0,t.sample)(s);return this.nodes[e][r]}findOrCreate(e,n=!1){const o=(0,s.getNodeKey)(e);let a;return n=Boolean(n),this.specifiedOptions[o]?Object.assign(e,this.specifiedOptions[o]):this.specifiedOptions[o]=e,this.nodes.all[o]?(a=this.nodes.all[o],a.options.readOnly!==n&&(a.options.readOnly=n,i("Change role of %s to %s",o,n?"slave":"master"),a[n?"readonly":"readwrite"]().catch(t.noop),n?(delete this.nodes.master[o],this.nodes.slave[o]=a):(delete this.nodes.slave[o],this.nodes.master[o]=a))):(i("Connecting to %s as %s",o,n?"slave":"master"),a=new r.default((0,t.defaults)({retryStrategy:null,enableOfflineQueue:!0,readOnly:n},e,this.redisOptions,{lazyConnect:!0})),this.nodes.all[o]=a,this.nodes[n?"slave":"master"][o]=a,a.once("end",(()=>{this.removeNode(o),this.emit("-node",a,o),Object.keys(this.nodes.all).length||this.emit("drain")})),this.emit("+node",a,o),a.on("error",(function(e){this.emit("nodeError",e,o)}))),a}reset(e){i("Reset with %O",e);const t={};e.forEach((e=>{const r=(0,s.getNodeKey)(e);e.readOnly&&t[r]||(t[r]=e)})),Object.keys(this.nodes.all).forEach((e=>{t[e]||(i("Disconnect %s because the node does not hold any slot",e),this.nodes.all[e].disconnect(),this.removeNode(e))})),Object.keys(t).forEach((e=>{const s=t[e];this.findOrCreate(s,s.readOnly)}))}removeNode(e){const{nodes:t}=this;t.all[e]&&(i("Remove %s from the pool",e),delete t.all[e]),delete t.master[e],delete t.slave[e]}}return kr.default=n,kr}(),y=Sr,m=fr,g=wr,k=(0,c.Debug)("cluster"),S=new WeakSet;class _ extends h.default{constructor(e,s={}){if(super(),this.slots=[],this._groupsIds={},this._groupsBySlot=Array(16384),this.isCluster=!0,this.retryAttempts=0,this.delayQueue=new y.default,this.offlineQueue=new g,this.isRefreshing=!1,this._refreshSlotsCacheCallbacks=[],this._autoPipelines=new Map,this._runningAutoPipelines=new Set,this._readyDelayedCallbacks=[],this.connectionEpoch=0,t.EventEmitter.call(this),this.startupNodes=e,this.options=(0,c.defaults)({},s,d.DEFAULT_CLUSTER_OPTIONS,this.options),this.options.redisOptions&&this.options.redisOptions.keyPrefix&&!this.options.keyPrefix&&(this.options.keyPrefix=this.options.redisOptions.keyPrefix),"function"!=typeof this.options.scaleReads&&-1===["all","master","slave"].indexOf(this.options.scaleReads))throw new Error('Invalid option scaleReads "'+this.options.scaleReads+'". Expected "all", "master", "slave" or a custom function');this.connectionPool=new f.default(this.options.redisOptions),this.connectionPool.on("-node",((e,t)=>{this.emit("-node",e)})),this.connectionPool.on("+node",(e=>{this.emit("+node",e)})),this.connectionPool.on("drain",(()=>{this.setStatus("close")})),this.connectionPool.on("nodeError",((e,t)=>{this.emit("node error",e,t)})),this.subscriber=new p.default(this.connectionPool,this),this.options.scripts&&Object.entries(this.options.scripts).forEach((([e,t])=>{this.defineCommand(e,t)})),this.options.lazyConnect?this.setStatus("wait"):this.connect().catch((e=>{k("connecting failed: %s",e)}))}connect(){return new Promise(((e,t)=>{if("connecting"===this.status||"connect"===this.status||"ready"===this.status)return void t(new Error("Redis is already connecting/connected"));const r=++this.connectionEpoch;this.setStatus("connecting"),this.resolveStartupNodeHostnames().then((i=>{if(this.connectionEpoch!==r)return k("discard connecting after resolving startup nodes because epoch not match: %d != %d",r,this.connectionEpoch),void t(new s.RedisError("Connection is discarded because a new connection is made"));if("connecting"!==this.status)return k("discard connecting after resolving startup nodes because the status changed to %s",this.status),void t(new s.RedisError("Connection is aborted"));this.connectionPool.reset(i);const a=()=>{this.setStatus("ready"),this.retryAttempts=0,this.executeOfflineCommands(),this.resetNodesRefreshInterval(),e()};let l;const c=()=>{this.invokeReadyDelayedCallbacks(void 0),this.removeListener("close",l),this.manuallyClosing=!1,this.setStatus("connect"),this.options.enableReadyCheck?this.readyCheck(((e,t)=>{e||t?(k("Ready check failed (%s). Reconnecting...",e||t),"connect"===this.status&&this.disconnect(!0)):a()})):a()};l=()=>{const e=new Error("None of startup nodes is available");this.removeListener("refresh",c),this.invokeReadyDelayedCallbacks(e),t(e)},this.once("refresh",c),this.once("close",l),this.once("close",this.handleCloseEvent.bind(this)),this.refreshSlotsCache((e=>{e&&e.message===n.default.defaultMessage&&(o.default.prototype.silentEmit.call(this,"error",e),this.connectionPool.reset([]))})),this.subscriber.start()})).catch((e=>{this.setStatus("close"),this.handleCloseEvent(e),this.invokeReadyDelayedCallbacks(e),t(e)}))}))}disconnect(e=!1){const t=this.status;this.setStatus("disconnecting"),e||(this.manuallyClosing=!0),this.reconnectTimeout&&!e&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,k("Canceled reconnecting attempts")),this.clearNodesRefreshInterval(),this.subscriber.stop(),"wait"===t?(this.setStatus("close"),this.handleCloseEvent()):this.connectionPool.reset([])}quit(e){const t=this.status;if(this.setStatus("disconnecting"),this.manuallyClosing=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.clearNodesRefreshInterval(),this.subscriber.stop(),"wait"===t){const t=(0,r.default)(Promise.resolve("OK"),e);return setImmediate(function(){this.setStatus("close"),this.handleCloseEvent()}.bind(this)),t}return(0,r.default)(Promise.all(this.nodes().map((e=>e.quit().catch((e=>{if(e.message===c.CONNECTION_CLOSED_ERROR_MSG)return"OK";throw e}))))).then((()=>"OK")),e)}duplicate(e=[],t={}){const s=e.length>0?e:this.startupNodes.slice(0),r=Object.assign({},this.options,t);return new _(s,r)}nodes(e="all"){if("all"!==e&&"master"!==e&&"slave"!==e)throw new Error('Invalid role "'+e+'". Expected "all", "master" or "slave"');return this.connectionPool.getNodes(e)}delayUntilReady(e){this._readyDelayedCallbacks.push(e)}get autoPipelineQueueSize(){let e=0;for(const t of this._autoPipelines.values())e+=t.length;return e}refreshSlotsCache(e){if(e&&this._refreshSlotsCacheCallbacks.push(e),this.isRefreshing)return;this.isRefreshing=!0;const t=this,s=e=>{this.isRefreshing=!1;for(const t of this._refreshSlotsCacheCallbacks)t(e);this._refreshSlotsCacheCallbacks=[]},r=(0,c.shuffle)(this.connectionPool.getNodes());let i=null;!function e(o){if(o===r.length){const e=new n.default(n.default.defaultMessage,i);return s(e)}const a=r[o],l=`${a.options.host}:${a.options.port}`;k("getting slot cache from %s",l),t.getInfoFromNode(a,(function(r){switch(t.status){case"close":case"end":return s(new Error("Cluster is disconnected."));case"disconnecting":return s(new Error("Cluster is disconnecting."))}r?(t.emit("node error",r,l),i=r,e(o+1)):(t.emit("refresh"),s())}))}(0)}sendCommand(t,r,n){if("wait"===this.status&&this.connect().catch(c.noop),"end"===this.status)return t.reject(new Error(c.CONNECTION_CLOSED_ERROR_MSG)),t.promise;let o=this.options.scaleReads;if("master"!==o){t.isReadOnly||(0,e.exists)(t.name)&&(0,e.hasFlag)(t.name,"readonly")||(o="master")}let a=n?n.slot:t.getSlot();const l={},u=this;if(!n&&!S.has(t)){S.add(t);const e=t.reject;t.reject=function(s){const r=h.bind(null,!0);u.handleError(s,l,{moved:function(e,s){k("command %s is moved to %s",t.name,s),a=Number(e),u.slots[e]?u.slots[e][0]=s:u.slots[e]=[s],u._groupsBySlot[e]=u._groupsIds[u.slots[e].join(";")],u.connectionPool.findOrCreate(u.natMapper(s)),h(),k("refreshing slot caches... (triggered by MOVED error)"),u.refreshSlotsCache()},ask:function(e,s){k("command %s is required to ask %s:%s",t.name,s);const r=u.natMapper(s);u.connectionPool.findOrCreate(r),h(!1,`${r.host}:${r.port}`)},tryagain:r,clusterDown:r,connectionClosed:r,maxRedirections:function(s){e.call(t,s)},defaults:function(){e.call(t,s)}})}}function h(e,l){if("end"===u.status)return void t.reject(new s.AbortError("Cluster is ended."));let h;if("ready"===u.status||"cluster"===t.name){if(n&&n.redis)h=n.redis;else if(i.default.checkFlag("ENTER_SUBSCRIBER_MODE",t.name)||i.default.checkFlag("EXIT_SUBSCRIBER_MODE",t.name)){if(h=u.subscriber.getInstance(),!h)return void t.reject(new s.AbortError("No subscriber for the cluster"))}else{if(!e){if("number"==typeof a&&u.slots[a]){const e=u.slots[a];if("function"==typeof o){const s=e.map((function(e){return u.connectionPool.getInstanceByKey(e)}));h=o(s,t),Array.isArray(h)&&(h=(0,c.sample)(h)),h||(h=s[0])}else{let t;t="all"===o?(0,c.sample)(e):"slave"===o&&e.length>1?(0,c.sample)(e,1):e[0],h=u.connectionPool.getInstanceByKey(t)}}l&&(h=u.connectionPool.getInstanceByKey(l),h.asking())}h||(h=("function"==typeof o?null:u.connectionPool.getSampleInstance(o))||u.connectionPool.getSampleInstance("all"))}n&&!n.redis&&(n.redis=h)}h?h.sendCommand(t,r):u.options.enableOfflineQueue?u.offlineQueue.push({command:t,stream:r,node:n}):t.reject(new Error("Cluster isn't ready and enableOfflineQueue options is false"))}return h(),t.promise}sscanStream(e,t){return this.createScanStream("sscan",{key:e,options:t})}sscanBufferStream(e,t){return this.createScanStream("sscanBuffer",{key:e,options:t})}hscanStream(e,t){return this.createScanStream("hscan",{key:e,options:t})}hscanBufferStream(e,t){return this.createScanStream("hscanBuffer",{key:e,options:t})}zscanStream(e,t){return this.createScanStream("zscan",{key:e,options:t})}zscanBufferStream(e,t){return this.createScanStream("zscanBuffer",{key:e,options:t})}handleError(e,t,s){if(void 0===t.value?t.value=this.options.maxRedirections:t.value-=1,t.value<=0)return void s.maxRedirections(new Error("Too many Cluster redirections. Last error: "+e));const r=e.message.split(" ");if("MOVED"===r[0]){const e=this.options.retryDelayOnMoved;e&&"number"==typeof e?this.delayQueue.push("moved",s.moved.bind(null,r[1],r[2]),{timeout:e}):s.moved(r[1],r[2])}else"ASK"===r[0]?s.ask(r[1],r[2]):"TRYAGAIN"===r[0]?this.delayQueue.push("tryagain",s.tryagain,{timeout:this.options.retryDelayOnTryAgain}):"CLUSTERDOWN"===r[0]&&this.options.retryDelayOnClusterDown>0?this.delayQueue.push("clusterdown",s.connectionClosed,{timeout:this.options.retryDelayOnClusterDown,callback:this.refreshSlotsCache.bind(this)}):e.message===c.CONNECTION_CLOSED_ERROR_MSG&&this.options.retryDelayOnFailover>0&&"ready"===this.status?this.delayQueue.push("failover",s.connectionClosed,{timeout:this.options.retryDelayOnFailover,callback:this.refreshSlotsCache.bind(this)}):s.defaults()}resetOfflineQueue(){this.offlineQueue=new g}clearNodesRefreshInterval(){this.slotsTimer&&(clearTimeout(this.slotsTimer),this.slotsTimer=null)}resetNodesRefreshInterval(){if(this.slotsTimer||!this.options.slotsRefreshInterval)return;const e=()=>{this.slotsTimer=setTimeout((()=>{k('refreshing slot caches... (triggered by "slotsRefreshInterval" option)'),this.refreshSlotsCache((()=>{e()}))}),this.options.slotsRefreshInterval)};e()}setStatus(e){k("status: %s -> %s",this.status||"[empty]",e),this.status=e,process.nextTick((()=>{this.emit(e)}))}handleCloseEvent(e){let t;e&&k("closed because %s",e),this.manuallyClosing||"function"!=typeof this.options.clusterRetryStrategy||(t=this.options.clusterRetryStrategy.call(this,++this.retryAttempts,e)),"number"==typeof t?(this.setStatus("reconnecting"),this.reconnectTimeout=setTimeout((()=>{this.reconnectTimeout=null,k("Cluster is disconnected. Retrying after %dms",t),this.connect().catch((function(e){k("Got error %s when reconnecting. Ignoring...",e)}))}),t)):(this.setStatus("end"),this.flushQueue(new Error("None of startup nodes is available")))}flushQueue(e){let t;for(;t=this.offlineQueue.shift();)t.command.reject(e)}executeOfflineCommands(){if(this.offlineQueue.length){k("send %d commands in offline queue",this.offlineQueue.length);const e=this.offlineQueue;let t;for(this.resetOfflineQueue();t=e.shift();)this.sendCommand(t.command,t.stream,t.node)}}natMapper(e){if(this.options.natMap&&"object"==typeof this.options.natMap){const t="string"==typeof e?e:`${e.host}:${e.port}`,s=this.options.natMap[t];if(s)return k("NAT mapping %s -> %O",t,s),Object.assign({},s)}return"string"==typeof e?(0,m.nodeKeyToRedisOptions)(e):e}getInfoFromNode(e,t){if(!e)return t(new Error("Node is disconnected"));const s=e.duplicate({enableOfflineQueue:!0,enableReadyCheck:!1,retryStrategy:null,connectionName:(0,m.getConnectionName)("refresher",this.options.redisOptions&&this.options.redisOptions.connectionName)});s.on("error",c.noop),s.cluster("SLOTS",(0,c.timeout)(((e,r)=>{if(s.disconnect(),e)return t(e);if("disconnecting"===this.status||"close"===this.status||"end"===this.status)return k("ignore CLUSTER.SLOTS results (count: %d) since cluster status is %s",r.length,this.status),void t();const i=[];k("cluster slots result count: %d",r.length);for(let e=0;e<r.length;++e){const t=r[e],s=t[0],n=t[1],o=[];for(let e=2;e<t.length;e++){if(!t[e][0])continue;const s=this.natMapper({host:t[e][0],port:t[e][1]});s.readOnly=2!==e,i.push(s),o.push(s.host+":"+s.port)}k("cluster slots result [%d]: slots %d~%d served by %s",e,s,n,o);for(let e=s;e<=n;e++)this.slots[e]=o}this._groupsIds=Object.create(null);let n=0;for(let e=0;e<16384;e++){const t=(this.slots[e]||[]).join(";");t.length?(this._groupsIds[t]||(this._groupsIds[t]=++n),this._groupsBySlot[e]=this._groupsIds[t]):this._groupsBySlot[e]=void 0}this.connectionPool.reset(i),t()}),this.options.slotsRefreshTimeout))}invokeReadyDelayedCallbacks(e){for(const t of this._readyDelayedCallbacks)process.nextTick(t,e);this._readyDelayedCallbacks=[]}readyCheck(e){this.cluster("INFO",((t,s)=>{if(t)return e(t);if("string"!=typeof s)return e();let r;const i=s.split("\r\n");for(let e=0;e<i.length;++e){const t=i[e].split(":");if("cluster_state"===t[0]){r=t[1];break}}"fail"===r?(k("cluster state not ok (%s)",r),e(null,r)):e()}))}resolveSrv(e){return new Promise(((t,s)=>{this.options.resolveSrv(e,((e,r)=>{if(e)return s(e);const i=this,n=(0,m.groupSrvRecords)(r),o=Object.keys(n).sort(((e,t)=>parseInt(e)-parseInt(t)));!function e(r){if(!o.length)return s(r);const a=o[0],l=n[a],c=(0,m.weightSrvRecords)(l);l.records.length||o.shift(),i.dnsLookup(c.name).then((e=>t({host:e,port:c.port})),e)}()}))}))}dnsLookup(e){return new Promise(((t,s)=>{this.options.dnsLookup(e,((r,i)=>{r?(k("failed to resolve hostname %s to IP: %s",e,r.message),s(r)):(k("resolved hostname %s to IP %s",e,i),t(i))}))}))}async resolveStartupNodeHostnames(){if(!Array.isArray(this.startupNodes)||0===this.startupNodes.length)throw new Error("`startupNodes` should contain at least one node.");const e=(0,m.normalizeNodeOptions)(this.startupNodes),t=(0,m.getUniqueHostnamesFromOptions)(e);if(0===t.length)return e;const s=await Promise.all(t.map((this.options.useSRVRecords?this.resolveSrv:this.dnsLookup).bind(this))),r=(0,c.zipMap)(t,s);return e.map((e=>{const t=r.get(e.host);return t?this.options.useSRVRecords?Object.assign({},e,t):Object.assign({},e,{host:t}):e}))}createScanStream(e,{key:t,options:s={}}){return new a.default({objectMode:!0,key:t,redis:this,command:e,...s})}}return(0,u.default)(_,t.EventEmitter),(0,l.addTransactionSupport)(_.prototype),nt.default=_,nt}Sr.default=class{constructor(){this.queues={},this.timeouts={}}push(e,t,s){const r=s.callback||process.nextTick;this.queues[e]||(this.queues[e]=new vr);this.queues[e].push(t),this.timeouts[e]||(this.timeouts[e]=setTimeout((()=>{r((()=>{this.timeouts[e]=null,this.execute(e)}))}),s.timeout))}execute(e){const t=this.queues[e];if(!t)return;const{length:s}=t;if(s)for(Er("send %d commands in %s queue",s,e),this.queues[e]=null;t.length>0;)t.shift()()}};var Ar={},Tr={},Rr={};Object.defineProperty(Rr,"__esModule",{value:!0});const Mr=(0,dt.Debug)("AbstractConnector");Rr.default=class{constructor(e){this.connecting=!1,this.disconnectTimeout=e}check(e){return!0}disconnect(){if(this.connecting=!1,this.stream){const e=this.stream,t=setTimeout((()=>{Mr("stream %s:%s still open, destroying it",e.remoteAddress,e.remotePort),e.destroy()}),this.disconnectTimeout);e.on("close",(()=>clearTimeout(t))),e.end()}}},Object.defineProperty(Tr,"__esModule",{value:!0});const Or=x.default,Pr=A.default,Br=dt,Nr=Rr;class Ir extends Nr.default{constructor(e){super(e.disconnectTimeout),this.options=e}connect(e){const{options:t}=this;let s;return this.connecting=!0,"path"in t&&t.path?s={path:t.path}:(s={},"port"in t&&null!=t.port&&(s.port=t.port),"host"in t&&null!=t.host&&(s.host=t.host),"family"in t&&null!=t.family&&(s.family=t.family)),t.tls&&Object.assign(s,t.tls),new Promise(((e,r)=>{process.nextTick((()=>{if(this.connecting){try{t.tls?this.stream=(0,Pr.connect)(s):this.stream=(0,Or.createConnection)(s)}catch(e){return void r(e)}this.stream.once("error",(e=>{this.firstError=e})),e(this.stream)}else r(new Error(Br.CONNECTION_CLOSED_ERROR_MSG))}))}))}}Tr.default=Ir;var Dr={},Lr={};Object.defineProperty(Lr,"__esModule",{value:!0});Lr.default=class{constructor(e){this.cursor=0,this.sentinels=e.slice(0)}next(){const e=this.cursor>=this.sentinels.length;return{done:e,value:e?void 0:this.sentinels[this.cursor++]}}reset(e){e&&this.sentinels.length>1&&1!==this.cursor&&this.sentinels.unshift(...this.sentinels.splice(this.cursor-1)),this.cursor=0}add(e){for(let r=0;r<this.sentinels.length;r++)if(t=e,s=this.sentinels[r],(t.host||"127.0.0.1")===(s.host||"127.0.0.1")&&(t.port||26379)===(s.port||26379))return!1;var t,s;return this.sentinels.push(e),!0}toString(){return`${JSON.stringify(this.sentinels)} @${this.cursor}`}};var jr={};Object.defineProperty(jr,"__esModule",{value:!0}),jr.FailoverDetector=void 0;const Fr=(0,dt.Debug)("FailoverDetector"),Qr="+switch-master";var zr,Ur;function Gr(){if(zr)return Dr;zr=1,Object.defineProperty(Dr,"__esModule",{value:!0}),Dr.SentinelIterator=void 0;const e=x.default,t=dt,s=A.default,r=Lr;Dr.SentinelIterator=r.default;const i=Rr,n=Ri(),o=jr,a=(0,t.Debug)("SentinelConnector");class l extends i.default{constructor(e){if(super(e.disconnectTimeout),this.options=e,this.emitter=null,this.failoverDetector=null,!this.options.sentinels.length)throw new Error("Requires at least one sentinel to connect to.");if(!this.options.name)throw new Error("Requires the name of master.");this.sentinelIterator=new r.default(this.options.sentinels)}check(e){const t=!e.role||this.options.role===e.role;return t||(a("role invalid, expected %s, but got %s",this.options.role,e.role),this.sentinelIterator.next(),this.sentinelIterator.next(),this.sentinelIterator.reset(!0)),t}disconnect(){super.disconnect(),this.failoverDetector&&this.failoverDetector.cleanup()}connect(r){let i;this.connecting=!0,this.retryAttempts=0;const n=async()=>{const o=this.sentinelIterator.next();if(o.done){this.sentinelIterator.reset(!1);const e="function"==typeof this.options.sentinelRetryStrategy?this.options.sentinelRetryStrategy(++this.retryAttempts):null;let t="number"!=typeof e?"All sentinels are unreachable and retry is disabled.":`All sentinels are unreachable. Retrying from scratch after ${e}ms.`;i&&(t+=` Last error: ${i.message}`),a(t);const s=new Error(t);if("number"==typeof e)return r("error",s),await new Promise((t=>setTimeout(t,e))),n();throw s}let l=null,c=null;try{l=await this.resolve(o.value)}catch(e){c=e}if(!this.connecting)throw new Error(t.CONNECTION_CLOSED_ERROR_MSG);const u=o.value.host+":"+o.value.port;if(l)return a("resolved: %s:%s from sentinel %s",l.host,l.port,u),this.options.enableTLSForSentinelMode&&this.options.tls?(Object.assign(l,this.options.tls),this.stream=(0,s.connect)(l),this.stream.once("secureConnect",this.initFailoverDetector.bind(this))):(this.stream=(0,e.createConnection)(l),this.stream.once("connect",this.initFailoverDetector.bind(this))),this.stream.once("error",(e=>{this.firstError=e})),this.stream;{const e=c?"failed to connect to sentinel "+u+" because "+c.message:"connected to sentinel "+u+" successfully, but got an invalid reply: "+l;return a(e),r("sentinelError",new Error(e)),c&&(i=c),n()}};return n()}async updateSentinels(e){if(!this.options.updateSentinels)return;const s=await e.sentinel("sentinels",this.options.name);Array.isArray(s)&&(s.map(t.packObject).forEach((e=>{if(-1===(e.flags?e.flags.split(","):[]).indexOf("disconnected")&&e.ip&&e.port){const t=this.sentinelNatResolve(c(e));this.sentinelIterator.add(t)&&a("adding sentinel %s:%s",t.host,t.port)}})),a("Updated internal sentinels: %s",this.sentinelIterator))}async resolveMaster(e){const t=await e.sentinel("get-master-addr-by-name",this.options.name);return await this.updateSentinels(e),this.sentinelNatResolve(Array.isArray(t)?{host:t[0],port:Number(t[1])}:null)}async resolveSlave(e){const s=await e.sentinel("slaves",this.options.name);if(!Array.isArray(s))return null;const r=s.map(t.packObject).filter((e=>e.flags&&!e.flags.match(/(disconnected|s_down|o_down)/)));return this.sentinelNatResolve(function(e,s){if(0===e.length)return null;let r;if("function"==typeof s)r=s(e);else if(null!==s&&"object"==typeof s){const t=Array.isArray(s)?s:[s];t.sort(((e,t)=>(e.prio||(e.prio=1),t.prio||(t.prio=1),e.prio<t.prio?-1:e.prio>t.prio?1:0)));for(let s=0;s<t.length;s++){for(let i=0;i<e.length;i++){const n=e[i];if(n.ip===t[s].ip&&n.port===t[s].port){r=n;break}}if(r)break}}r||(r=(0,t.sample)(e));return c(r)}(r,this.options.preferredSlaves))}sentinelNatResolve(e){return e&&this.options.natMap&&this.options.natMap[`${e.host}:${e.port}`]||e}connectToSentinel(e,t){return new n.default({port:e.port||26379,host:e.host,username:this.options.sentinelUsername||null,password:this.options.sentinelPassword||null,family:e.family||("path"in this.options&&this.options.path?void 0:this.options.family),tls:this.options.sentinelTLS,retryStrategy:null,enableReadyCheck:!1,connectTimeout:this.options.connectTimeout,commandTimeout:this.options.sentinelCommandTimeout,...t})}async resolve(e){const t=this.connectToSentinel(e);t.on("error",u);try{return"slave"===this.options.role?await this.resolveSlave(t):await this.resolveMaster(t)}finally{t.disconnect()}}async initFailoverDetector(){var e;if(!this.options.failoverDetector)return;this.sentinelIterator.reset(!0);const t=[];for(;t.length<this.options.sentinelMaxConnections;){const{done:e,value:s}=this.sentinelIterator.next();if(e)break;const r=this.connectToSentinel(s,{lazyConnect:!0,retryStrategy:this.options.sentinelReconnectStrategy});r.on("reconnecting",(()=>{var e;null===(e=this.emitter)||void 0===e||e.emit("sentinelReconnecting")})),t.push({address:s,client:r})}this.sentinelIterator.reset(!1),this.failoverDetector&&this.failoverDetector.cleanup(),this.failoverDetector=new o.FailoverDetector(this,t),await this.failoverDetector.subscribe(),null===(e=this.emitter)||void 0===e||e.emit("failoverSubscribed")}}function c(e){return{host:e.ip,port:Number(e.port)}}function u(){}return Dr.default=l,Dr}jr.FailoverDetector=class{constructor(e,t){this.isDisconnected=!1,this.connector=e,this.sentinels=t}cleanup(){this.isDisconnected=!0;for(const e of this.sentinels)e.client.disconnect()}async subscribe(){Fr("Starting FailoverDetector");const e=[];for(const t of this.sentinels){const s=t.client.subscribe(Qr).catch((e=>{Fr("Failed to subscribe to failover messages on sentinel %s:%s (%s)",t.address.host||"127.0.0.1",t.address.port||26739,e.message)}));e.push(s),t.client.on("message",(e=>{this.isDisconnected||e!==Qr||this.disconnect()}))}await Promise.all(e)}disconnect(){this.isDisconnected=!0,Fr("Failover detected, disconnecting"),this.connector.disconnect()}};var Kr={},qr={},Yr={};Object.defineProperty(Yr,"__esModule",{value:!0});const Wr=at;class Vr extends Wr.AbortError{constructor(e){super(`Reached the max retries per request limit (which is ${e}). Refer to "maxRetriesPerRequest" option for details.`),Error.captureStackTrace(this,this.constructor)}get name(){return this.constructor.name}}Yr.default=Vr,Object.defineProperty(qr,"__esModule",{value:!0}),qr.MaxRetriesPerRequestError=void 0;const Hr=Yr;qr.MaxRetriesPerRequestError=Hr.default;var Jr={},Xr={},Zr={get exports(){return Xr},set exports(e){Xr=e}};const $r=T.default.Buffer,ei=new(0,R.default.StringDecoder),ti=at,si=ti.ReplyError,ri=ti.ParserError;var ii=$r.allocUnsafe(32768),ni=0,oi=null,ai=0,li=0;function ci(e){const t=e.offset,s=e.buffer,r=s.length-1;for(var i=t;i<r;)if(13===s[i++])return e.offset=i+1,!0===e.optionReturnBuffers?e.buffer.slice(t,i-1):e.buffer.toString("utf8",t,i-1)}function ui(e){const t=e.buffer.length-1;for(var s=e.offset,r=0;s<t;){const t=e.buffer[s++];if(13===t)return e.offset=s+1,r;r=10*r+(t-48)}}function hi(e,t,s){e.arrayCache.push(t),e.arrayPos.push(s)}function di(e){const t=e.arrayCache.pop();var s=e.arrayPos.pop();if(e.arrayCache.length){const r=di(e);if(void 0===r)return void hi(e,t,s);t[s++]=r}return pi(e,t,s)}function pi(e,t,s){const r=e.buffer.length;for(;s<t.length;){const i=e.offset;if(e.offset>=r)return void hi(e,t,s);const n=fi(e,e.buffer[e.offset++]);if(void 0===n)return e.arrayCache.length||e.bufferCache.length||(e.offset=i),void hi(e,t,s);t[s]=n,s++}return t}function fi(e,t){switch(t){case 36:return function(e){const t=ui(e);if(void 0===t)return;if(t<0)return null;const s=e.offset+t;if(s+2>e.buffer.length)return e.bigStrSize=s+2,e.totalChunkSize=e.buffer.length,void e.bufferCache.push(e.buffer);const r=e.offset;return e.offset=s+2,!0===e.optionReturnBuffers?e.buffer.slice(r,s):e.buffer.toString("utf8",r,s)}(e);case 43:return ci(e);case 42:return function(e){const t=ui(e);if(void 0===t)return;return t<0?null:pi(e,new Array(t),0)}(e);case 58:return function(e){return!0===e.optionStringNumbers?function(e){const t=e.buffer.length-1;var s=e.offset,r=0,i="";for(45===e.buffer[s]&&(i+="-",s++);s<t;){var n=e.buffer[s++];if(13===n)return e.offset=s+1,0!==r&&(i+=r),i;r>429496728?(i+=10*r+(n-48),r=0):48===n&&0===r?i+=0:r=10*r+(n-48)}}(e):function(e){const t=e.buffer.length-1;var s=e.offset,r=0,i=1;for(45===e.buffer[s]&&(i=-1,s++);s<t;){const t=e.buffer[s++];if(13===t)return e.offset=s+1,i*r;r=10*r+(t-48)}}(e)}(e);case 45:return function(e){var t=ci(e);if(void 0!==t)return!0===e.optionReturnBuffers&&(t=t.toString()),new si(t)}(e);default:return function(e,t){const s=new ri("Protocol error, got "+JSON.stringify(String.fromCharCode(t))+" as reply type byte",JSON.stringify(e.buffer),e.offset);e.buffer=null,e.returnFatalError(s)}(e,t)}}function yi(){if(ii.length>51200)if(1===ai||li>2*ai){const e=Math.floor(ii.length/10),t=e<ni?ni:e;ni=0,ii=ii.slice(t,ii.length)}else li++,ai--;else clearInterval(oi),ai=0,li=0,oi=null}function mi(e){const t=e.bufferCache,s=e.offset,r=e.bigStrSize-s-2;var i=t.length,n=e.bigStrSize-e.totalChunkSize;if(e.offset=n,n<=2){if(2===i)return t[0].slice(s,t[0].length+n-2);i--,n=t[t.length-2].length+n}!function(e){if(ii.length<e+ni){const t=e>78643200?2:3;ni>116391936&&(ni=52428800),ii=$r.allocUnsafe(e*t+ni),ni=0,ai++,null===oi&&(oi=setInterval(yi,50))}}(r);const o=ni;t[0].copy(ii,o,s,t[0].length),ni+=t[0].length-s;for(var a=1;a<i-1;a++)t[a].copy(ii,ni),ni+=t[a].length;return t[a].copy(ii,ni,0,n-2),ni+=n-2,ii.slice(o,ni)}var gi=class{constructor(e){if(!e)throw new TypeError("Options are mandatory.");if("function"!=typeof e.returnError||"function"!=typeof e.returnReply)throw new TypeError("The returnReply and returnError options have to be functions.");this.setReturnBuffers(!!e.returnBuffers),this.setStringNumbers(!!e.stringNumbers),this.returnError=e.returnError,this.returnFatalError=e.returnFatalError||e.returnError,this.returnReply=e.returnReply,this.reset()}reset(){this.offset=0,this.buffer=null,this.bigStrSize=0,this.totalChunkSize=0,this.bufferCache=[],this.arrayCache=[],this.arrayPos=[]}setReturnBuffers(e){if("boolean"!=typeof e)throw new TypeError("The returnBuffers argument has to be a boolean");this.optionReturnBuffers=e}setStringNumbers(e){if("boolean"!=typeof e)throw new TypeError("The stringNumbers argument has to be a boolean");this.optionStringNumbers=e}execute(e){if(null===this.buffer)this.buffer=e,this.offset=0;else if(0===this.bigStrSize){const t=this.buffer.length,s=t-this.offset,r=$r.allocUnsafe(s+e.length);if(this.buffer.copy(r,0,this.offset,t),e.copy(r,s,0,e.length),this.buffer=r,this.offset=0,this.arrayCache.length){const e=di(this);if(void 0===e)return;this.returnReply(e)}}else{if(!(this.totalChunkSize+e.length>=this.bigStrSize))return this.bufferCache.push(e),void(this.totalChunkSize+=e.length);this.bufferCache.push(e);var t=this.optionReturnBuffers?mi(this):function(e){const t=e.bufferCache,s=e.offset;var r=t.length,i=e.bigStrSize-e.totalChunkSize;if(e.offset=i,i<=2){if(2===r)return t[0].toString("utf8",s,t[0].length+i-2);r--,i=t[t.length-2].length+i}for(var n=ei.write(t[0].slice(s)),o=1;o<r-1;o++)n+=ei.write(t[o]);return n+ei.end(t[o].slice(0,i-2))}(this);if(this.bigStrSize=0,this.bufferCache=[],this.buffer=e,this.arrayCache.length&&(this.arrayCache[0][this.arrayPos[0]++]=t,void 0===(t=di(this))))return;this.returnReply(t)}for(;this.offset<this.buffer.length;){const e=this.offset,t=this.buffer[this.offset++],s=fi(this,t);if(void 0===s)return void(this.arrayCache.length||this.bufferCache.length||(this.offset=e));45===t?this.returnError(s):this.returnReply(s)}this.buffer=null}};Zr.exports=gi;var bi={};Object.defineProperty(bi,"__esModule",{value:!0});function ki(e){return"unsubscribe"===e?"subscribe":"punsubscribe"===e?"psubscribe":"sunsubscribe"===e?"ssubscribe":e}bi.default=class{constructor(){this.set={subscribe:{},psubscribe:{},ssubscribe:{}}}add(e,t){this.set[ki(e)][t]=!0}del(e,t){delete this.set[ki(e)][t]}channels(e){return Object.keys(this.set[ki(e)])}isEmpty(){return 0===this.channels("subscribe").length&&0===this.channels("psubscribe").length&&0===this.channels("ssubscribe").length}},Object.defineProperty(Jr,"__esModule",{value:!0});const Si=lt,_i=Xr,wi=bi,vi=(0,dt.Debug)("dataHandler");Jr.default=class{constructor(e,t){this.redis=e;const s=new _i({stringNumbers:t.stringNumbers,returnBuffers:!0,returnError:e=>{this.returnError(e)},returnFatalError:e=>{this.returnFatalError(e)},returnReply:e=>{this.returnReply(e)}});e.stream.on("data",(e=>{s.execute(e)}))}returnFatalError(e){e.message+=". Please report this.",this.redis.recoverFromFatalError(e,e,{offlineQueue:!1})}returnError(e){const t=this.shiftCommand(e);t&&(e.command={name:t.command.name,args:t.command.args},this.redis.handleReconnection(e,t))}returnReply(e){if(this.handleMonitorReply(e))return;if(this.handleSubscriberReply(e))return;const t=this.shiftCommand(e);t&&(Si.default.checkFlag("ENTER_SUBSCRIBER_MODE",t.command.name)?(this.redis.condition.subscriber=new wi.default,this.redis.condition.subscriber.add(t.command.name,e[1].toString()),Ci(t.command,e[2])||this.redis.commandQueue.unshift(t)):Si.default.checkFlag("EXIT_SUBSCRIBER_MODE",t.command.name)?xi(t.command,e[2])||this.redis.commandQueue.unshift(t):t.command.resolve(e))}handleSubscriberReply(e){if(!this.redis.condition.subscriber)return!1;const t=Array.isArray(e)?e[0].toString():null;switch(vi('receive reply "%s" in subscriber mode',t),t){case"message":this.redis.listeners("message").length>0&&this.redis.emit("message",e[1].toString(),e[2]?e[2].toString():""),this.redis.emit("messageBuffer",e[1],e[2]);break;case"pmessage":{const t=e[1].toString();this.redis.listeners("pmessage").length>0&&this.redis.emit("pmessage",t,e[2].toString(),e[3].toString()),this.redis.emit("pmessageBuffer",t,e[2],e[3]);break}case"smessage":this.redis.listeners("smessage").length>0&&this.redis.emit("smessage",e[1].toString(),e[2]?e[2].toString():""),this.redis.emit("smessageBuffer",e[1],e[2]);break;case"ssubscribe":case"subscribe":case"psubscribe":{const s=e[1].toString();this.redis.condition.subscriber.add(t,s);const r=this.shiftCommand(e);if(!r)return;Ci(r.command,e[2])||this.redis.commandQueue.unshift(r);break}case"sunsubscribe":case"unsubscribe":case"punsubscribe":{const s=e[1]?e[1].toString():null;s&&this.redis.condition.subscriber.del(t,s);const r=e[2];0===Number(r)&&(this.redis.condition.subscriber=!1);const i=this.shiftCommand(e);if(!i)return;xi(i.command,r)||this.redis.commandQueue.unshift(i);break}default:{const t=this.shiftCommand(e);if(!t)return;t.command.resolve(e)}}return!0}handleMonitorReply(e){if("monitoring"!==this.redis.status)return!1;const t=e.toString();if("OK"===t)return!1;const s=t.indexOf(" "),r=t.slice(0,s),i=t.indexOf('"'),n=t.slice(i+1,-1).split('" "').map((e=>e.replace(/\\"/g,'"'))),o=t.slice(s+2,i-2).split(" ");return this.redis.emit("monitor",r,n,o[1],o[0]),!0}shiftCommand(e){const t=this.redis.commandQueue.shift();if(!t){const t=new Error("Command queue state error. If you can reproduce this, please report it."+(e instanceof Error?` Last error: ${e.message}`:` Last reply: ${e.toString()}`));return this.redis.emit("error",t),null}return t}};const Ei=new WeakMap;function Ci(e,t){let s=Ei.has(e)?Ei.get(e):e.args.length;return s-=1,s<=0?(e.resolve(t),Ei.delete(e),!0):(Ei.set(e,s),!1)}function xi(e,t){let s=Ei.has(e)?Ei.get(e):e.args.length;return 0===s?0===Number(t)&&(Ei.delete(e),e.resolve(t),!0):(s-=1,s<=0?(e.resolve(t),!0):(Ei.set(e,s),!1))}!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.readyHandler=e.errorHandler=e.closeHandler=e.connectHandler=void 0;const t=at,s=lt,r=qr,i=dt,n=Jr,o=(0,i.Debug)("connection");function a(e){const s=new t.AbortError("Command aborted due to connection close");return s.command={name:e.name,args:e.args},s}e.connectHandler=function(t){return function(){t.setStatus("connect"),t.resetCommandQueue();let s=!1;const{connectionEpoch:r}=t;t.condition.auth&&t.auth(t.condition.auth,(function(e){r===t.connectionEpoch&&e&&(-1!==e.message.indexOf("no password is set")?console.warn("[WARN] Redis server does not require a password, but a password was supplied."):-1!==e.message.indexOf("without any password configured for the default user")?console.warn("[WARN] This Redis server's `default` user does not require a password, but a password was supplied"):-1!==e.message.indexOf("wrong number of arguments for 'auth' command")?console.warn("[ERROR] The server returned \"wrong number of arguments for 'auth' command\". You are probably passing both username and password to Redis version 5 or below. You should only pass the 'password' option for Redis version 5 and under."):(s=!0,t.recoverFromFatalError(e,e)))})),t.condition.select&&t.select(t.condition.select).catch((e=>{t.silentEmit("error",e)})),t.options.enableReadyCheck||e.readyHandler(t)(),new n.default(t,{stringNumbers:t.options.stringNumbers}),t.options.enableReadyCheck&&t._readyCheck((function(i,n){r===t.connectionEpoch&&(i?s||t.recoverFromFatalError(new Error("Ready check failed: "+i.message),i):t.connector.check(n)?e.readyHandler(t)():t.disconnect(!0))}))}},e.closeHandler=function(e){return function(){const s=e.status;if(e.setStatus("close"),e.commandQueue.length&&function(e){var t;let s=0;for(let r=0;r<e.length;){const i=null===(t=e.peekAt(r))||void 0===t?void 0:t.command,n=i.pipelineIndex;void 0!==n&&0!==n||(s=0),void 0===n||n===s++?r++:(e.remove(r,1),i.reject(a(i)))}}(e.commandQueue),e.offlineQueue.length&&function(e){var t;for(let s=0;s<e.length;){const r=null===(t=e.peekAt(s))||void 0===t?void 0:t.command;if("multi"===r.name)break;if("exec"===r.name){e.remove(s,1),r.reject(a(r));break}r.inTransaction?(e.remove(s,1),r.reject(a(r))):s++}}(e.offlineQueue),"ready"===s&&(e.prevCondition||(e.prevCondition=e.condition),e.commandQueue.length&&(e.prevCommandQueue=e.commandQueue)),e.manuallyClosing)return e.manuallyClosing=!1,o("skip reconnecting since the connection is manually closed."),t();if("function"!=typeof e.options.retryStrategy)return o("skip reconnecting because `retryStrategy` is not a function"),t();const n=e.options.retryStrategy(++e.retryAttempts);if("number"!=typeof n)return o("skip reconnecting because `retryStrategy` doesn't return a number"),t();o("reconnect in %sms",n),e.setStatus("reconnecting",n),e.reconnectTimeout=setTimeout((function(){e.reconnectTimeout=null,e.connect().catch(i.noop)}),n);const{maxRetriesPerRequest:l}=e.options;if("number"==typeof l)if(l<0)o("maxRetriesPerRequest is negative, ignoring...");else{0===e.retryAttempts%(l+1)&&(o("reach maxRetriesPerRequest limitation, flushing command queue..."),e.flushQueue(new r.MaxRetriesPerRequestError(l)))}};function t(){e.setStatus("end"),e.flushQueue(new Error(i.CONNECTION_CLOSED_ERROR_MSG))}},e.errorHandler=function(e){return function(t){o("error: %s",t),e.silentEmit("error",t)}},e.readyHandler=function(e){return function(){if(e.setStatus("ready"),e.retryAttempts=0,e.options.monitor){e.call("monitor").then((()=>e.setStatus("monitoring")),(t=>e.emit("error",t)));const{sendCommand:t}=e;return e.sendCommand=function(r){return s.default.checkFlag("VALID_IN_MONITOR_MODE",r.name)?t.call(e,r):(r.reject(new Error("Connection is in monitoring mode, can't process commands.")),r.promise)},void e.once("close",(function(){delete e.sendCommand}))}const t=e.prevCondition?e.prevCondition.select:e.condition.select;if(e.options.connectionName&&(o("set the connection name [%s]",e.options.connectionName),e.client("setname",e.options.connectionName).catch(i.noop)),e.options.readOnly&&(o("set the connection to readonly mode"),e.readonly().catch(i.noop)),e.prevCondition){const s=e.prevCondition;if(e.prevCondition=null,s.subscriber&&e.options.autoResubscribe){e.condition.select!==t&&(o("connect to db [%d]",t),e.select(t));const r=s.subscriber.channels("subscribe");r.length&&(o("subscribe %d channels",r.length),e.subscribe(r));const i=s.subscriber.channels("psubscribe");i.length&&(o("psubscribe %d channels",i.length),e.psubscribe(i));const n=s.subscriber.channels("ssubscribe");n.length&&(o("ssubscribe %d channels",n.length),e.ssubscribe(n))}}if(e.prevCommandQueue)if(e.options.autoResendUnfulfilledCommands)for(o("resend %d unfulfilled commands",e.prevCommandQueue.length);e.prevCommandQueue.length>0;){const t=e.prevCommandQueue.shift();t.select!==e.condition.select&&"select"!==t.command.name&&e.select(t.select),e.sendCommand(t.command,t.stream)}else e.prevCommandQueue=null;if(e.offlineQueue.length){o("send %d commands in offline queue",e.offlineQueue.length);const t=e.offlineQueue;for(e.resetOfflineQueue();t.length>0;){const s=t.shift();s.select!==e.condition.select&&"select"!==s.command.name&&e.select(s.select),e.sendCommand(s.command,s.stream)}}e.condition.select!==t&&(o("connect to db [%d]",t),e.select(t))}}}(Kr);var Ai,Ti={};function Ri(){if(Ai)return Ve;Ai=1,Object.defineProperty(Ve,"__esModule",{value:!0});const e=He,t=b.default,s=Xe,r=xr(),i=lt,n=function(){if(Ur)return Ar;Ur=1,Object.defineProperty(Ar,"__esModule",{value:!0}),Ar.SentinelConnector=Ar.StandaloneConnector=void 0;const e=Tr;Ar.StandaloneConnector=e.default;const t=Gr();return Ar.SentinelConnector=t.default,Ar}(),o=Gr(),a=Kr,l=Ti,c=Ps,u=Is,h=dt,d=ur,p=Ls,f=pt,y=wr,m=(0,h.Debug)("redis");class g extends p.default{constructor(e,s,r){if(super(),this.status="wait",this.isCluster=!1,this.reconnectTimeout=null,this.connectionEpoch=0,this.retryAttempts=0,this.manuallyClosing=!1,this._autoPipelines=new Map,this._runningAutoPipelines=new Set,this.parseOptions(e,s,r),t.EventEmitter.call(this),this.resetCommandQueue(),this.resetOfflineQueue(),this.options.Connector)this.connector=new this.options.Connector(this.options);else if(this.options.sentinels){const e=new o.default(this.options);e.emitter=this,this.connector=e}else this.connector=new n.StandaloneConnector(this.options);this.options.scripts&&Object.entries(this.options.scripts).forEach((([e,t])=>{this.defineCommand(e,t)})),this.options.lazyConnect?this.setStatus("wait"):this.connect().catch(f.noop)}static createClient(...e){return new g(...e)}get autoPipelineQueueSize(){let e=0;for(const t of this._autoPipelines.values())e+=t.length;return e}connect(e){const t=new Promise(((e,t)=>{if("connecting"===this.status||"connect"===this.status||"ready"===this.status)return void t(new Error("Redis is already connecting/connected"));this.connectionEpoch+=1,this.setStatus("connecting");const{options:r}=this;this.condition={select:r.db,auth:r.username?[r.username,r.password]:r.password,subscriber:!1};const i=this;(0,s.default)(this.connector.connect((function(e,t){i.silentEmit(e,t)})),(function(s,n){if(s)return i.flushQueue(s),i.silentEmit("error",s),t(s),void i.setStatus("end");let o=r.tls?"secureConnect":"connect";if("sentinels"in r&&r.sentinels&&!r.enableTLSForSentinelMode&&(o="connect"),i.stream=n,r.noDelay&&n.setNoDelay(!0),"number"==typeof r.keepAlive&&(n.connecting?n.once(o,(()=>{n.setKeepAlive(!0,r.keepAlive)})):n.setKeepAlive(!0,r.keepAlive)),n.connecting){if(n.once(o,a.connectHandler(i)),r.connectTimeout){let e=!1;n.setTimeout(r.connectTimeout,(function(){if(e)return;n.setTimeout(0),n.destroy();const t=new Error("connect ETIMEDOUT");t.errorno="ETIMEDOUT",t.code="ETIMEDOUT",t.syscall="connect",a.errorHandler(i)(t)})),n.once(o,(function(){e=!0,n.setTimeout(0)}))}}else if(n.destroyed){const e=i.connector.firstError;e&&process.nextTick((()=>{a.errorHandler(i)(e)})),process.nextTick(a.closeHandler(i))}else process.nextTick(a.connectHandler(i));n.destroyed||(n.once("error",a.errorHandler(i)),n.once("close",a.closeHandler(i)));const l=function(){i.removeListener("close",c),e()};var c=function(){i.removeListener("ready",l),t(new Error(h.CONNECTION_CLOSED_ERROR_MSG))};i.once("ready",l),i.once("close",c)}))}));return(0,s.default)(t,e)}disconnect(e=!1){e||(this.manuallyClosing=!0),this.reconnectTimeout&&!e&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),"wait"===this.status?a.closeHandler(this)():this.connector.disconnect()}end(){this.disconnect()}duplicate(e){return new g({...this.options,...e})}get mode(){var e;return this.options.monitor?"monitor":(null===(e=this.condition)||void 0===e?void 0:e.subscriber)?"subscriber":"normal"}monitor(e){const t=this.duplicate({monitor:!0,lazyConnect:!1});return(0,s.default)(new Promise((function(e,s){t.once("error",s),t.once("monitoring",(function(){e(t)}))})),e)}sendCommand(t,s){var r,n;if("wait"===this.status&&this.connect().catch(f.noop),"end"===this.status)return t.reject(new Error(h.CONNECTION_CLOSED_ERROR_MSG)),t.promise;if((null===(r=this.condition)||void 0===r?void 0:r.subscriber)&&!i.default.checkFlag("VALID_IN_SUBSCRIBER_MODE",t.name))return t.reject(new Error("Connection in subscriber mode, only subscriber commands may be used")),t.promise;"number"==typeof this.options.commandTimeout&&t.setTimeout(this.options.commandTimeout);let o="ready"===this.status||!s&&"connect"===this.status&&(0,e.exists)(t.name)&&(0,e.hasFlag)(t.name,"loading");if(this.stream&&this.stream.writable?this.stream._writableState&&this.stream._writableState.ended&&(o=!1):o=!1,o)m.enabled&&m("write command[%s]: %d -> %s(%o)",this._getDescription(),null===(n=this.condition)||void 0===n?void 0:n.select,t.name,t.args),s?"isPipeline"in s&&s.isPipeline?s.write(t.toWritable(s.destination.redis.stream)):s.write(t.toWritable(s)):this.stream.write(t.toWritable(this.stream)),this.commandQueue.push({command:t,stream:s,select:this.condition.select}),i.default.checkFlag("WILL_DISCONNECT",t.name)&&(this.manuallyClosing=!0),void 0!==this.options.socketTimeout&&void 0===this.socketTimeoutTimer&&this.setSocketTimeout();else{if(!this.options.enableOfflineQueue)return t.reject(new Error("Stream isn't writeable and enableOfflineQueue options is false")),t.promise;if("quit"===t.name&&0===this.offlineQueue.length)return this.disconnect(),t.resolve(Buffer.from("OK")),t.promise;m.enabled&&m("queue command[%s]: %d -> %s(%o)",this._getDescription(),this.condition.select,t.name,t.args),this.offlineQueue.push({command:t,stream:s,select:this.condition.select})}if("select"===t.name&&(0,h.isInt)(t.args[0])){const e=parseInt(t.args[0],10);this.condition.select!==e&&(this.condition.select=e,this.emit("select",e),m("switch to db [%d]",this.condition.select))}return t.promise}setSocketTimeout(){this.socketTimeoutTimer=setTimeout((()=>{this.stream.destroy(new Error(`Socket timeout. Expecting data, but didn't receive any in ${this.options.socketTimeout}ms.`)),this.socketTimeoutTimer=void 0}),this.options.socketTimeout),this.stream.once("data",(()=>{clearTimeout(this.socketTimeoutTimer),this.socketTimeoutTimer=void 0,0!==this.commandQueue.length&&this.setSocketTimeout()}))}scanStream(e){return this.createScanStream("scan",{options:e})}scanBufferStream(e){return this.createScanStream("scanBuffer",{options:e})}sscanStream(e,t){return this.createScanStream("sscan",{key:e,options:t})}sscanBufferStream(e,t){return this.createScanStream("sscanBuffer",{key:e,options:t})}hscanStream(e,t){return this.createScanStream("hscan",{key:e,options:t})}hscanBufferStream(e,t){return this.createScanStream("hscanBuffer",{key:e,options:t})}zscanStream(e,t){return this.createScanStream("zscan",{key:e,options:t})}zscanBufferStream(e,t){return this.createScanStream("zscanBuffer",{key:e,options:t})}silentEmit(e,t){let s;if("error"===e){if(s=t,"end"===this.status)return;if(this.manuallyClosing&&s instanceof Error&&(s.message===h.CONNECTION_CLOSED_ERROR_MSG||"connect"===s.syscall||"read"===s.syscall))return}return this.listeners(e).length>0?this.emit.apply(this,arguments):(s&&s instanceof Error&&console.error("[ioredis] Unhandled error event:",s.stack),!1)}recoverFromFatalError(e,t,s){this.flushQueue(t,s),this.silentEmit("error",t),this.disconnect(!0)}handleReconnection(e,t){var s;let r=!1;switch(this.options.reconnectOnError&&(r=this.options.reconnectOnError(e)),r){case 1:case!0:"reconnecting"!==this.status&&this.disconnect(!0),t.command.reject(e);break;case 2:"reconnecting"!==this.status&&this.disconnect(!0),(null===(s=this.condition)||void 0===s?void 0:s.select)!==t.select&&"select"!==t.command.name&&this.select(t.select),this.sendCommand(t.command);break;default:t.command.reject(e)}}_getDescription(){let e;return e="path"in this.options&&this.options.path?this.options.path:this.stream&&this.stream.remoteAddress&&this.stream.remotePort?this.stream.remoteAddress+":"+this.stream.remotePort:"host"in this.options&&this.options.host?this.options.host+":"+this.options.port:"",this.options.connectionName&&(e+=` (${this.options.connectionName})`),e}resetCommandQueue(){this.commandQueue=new y}resetOfflineQueue(){this.offlineQueue=new y}parseOptions(...e){const t={};let s=!1;for(let r=0;r<e.length;++r){const i=e[r];if(null!=i)if("object"==typeof i)(0,f.defaults)(t,i);else if("string"==typeof i)(0,f.defaults)(t,(0,h.parseURL)(i)),i.startsWith("rediss://")&&(s=!0);else{if("number"!=typeof i)throw new Error("Invalid argument "+i);t.port=i}}s&&(0,f.defaults)(t,{tls:!0}),(0,f.defaults)(t,g.defaultOptions),"string"==typeof t.port&&(t.port=parseInt(t.port,10)),"string"==typeof t.db&&(t.db=parseInt(t.db,10)),this.options=(0,h.resolveTLSProfile)(t)}setStatus(e,t){m.enabled&&m("status[%s]: %s -> %s",this._getDescription(),this.status||"[empty]",e),this.status=e,process.nextTick(this.emit.bind(this,e,t))}createScanStream(e,{key:t,options:s={}}){return new c.default({objectMode:!0,key:t,redis:this,command:e,...s})}flushQueue(e,t){let s;if((t=(0,f.defaults)({},t,{offlineQueue:!0,commandQueue:!0})).offlineQueue)for(;s=this.offlineQueue.shift();)s.command.reject(e);if(t.commandQueue&&this.commandQueue.length>0)for(this.stream&&this.stream.removeAllListeners("data");s=this.commandQueue.shift();)s.command.reject(e)}_readyCheck(e){const t=this;this.info((function(s,r){if(s)return s.message&&s.message.includes("NOPERM")?(console.warn(`Skipping the ready check because INFO command fails: "${s.message}". You can disable ready check with "enableReadyCheck". More: https://github.com/luin/ioredis/wiki/Disable-ready-check.`),e(null,{})):e(s);if("string"!=typeof r)return e(null,r);const i={},n=r.split("\r\n");for(let e=0;e<n.length;++e){const[t,...s]=n[e].split(":"),r=s.join(":");r&&(i[t]=r)}if(i.loading&&"0"!==i.loading){const s=1e3*(i.loading_eta_seconds||1),r=t.options.maxLoadingRetryTime&&t.options.maxLoadingRetryTime<s?t.options.maxLoadingRetryTime:s;m("Redis server still loading, trying again in "+r+"ms"),setTimeout((function(){t._readyCheck(e)}),r)}else e(null,i)})).catch(f.noop)}}return g.Cluster=r.default,g.Command=i.default,g.defaultOptions=l.DEFAULT_REDIS_OPTIONS,(0,d.default)(g,t.EventEmitter),(0,u.addTransactionSupport)(g.prototype),Ve.default=g,Ve}Object.defineProperty(Ti,"__esModule",{value:!0}),Ti.DEFAULT_REDIS_OPTIONS=void 0,Ti.DEFAULT_REDIS_OPTIONS={port:6379,host:"localhost",family:4,connectTimeout:1e4,disconnectTimeout:2e3,retryStrategy:function(e){return Math.min(50*e,2e3)},keepAlive:0,noDelay:!0,connectionName:null,sentinels:null,name:null,role:"master",sentinelRetryStrategy:function(e){return Math.min(10*e,1e3)},sentinelReconnectStrategy:function(){return 6e4},natMap:null,enableTLSForSentinelMode:!1,updateSentinels:!0,failoverDetector:!1,username:null,password:null,db:0,enableOfflineQueue:!0,enableReadyCheck:!0,autoResubscribe:!0,autoResendUnfulfilledCommands:!0,lazyConnect:!1,keyPrefix:"",reconnectOnError:null,readOnly:!1,stringNumbers:!1,maxRetriesPerRequest:20,maxLoadingRetryTime:1e4,enableAutoPipelining:!1,autoPipeliningIgnoredCommands:[],sentinelMaxConnections:10},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.print=t.ReplyError=t.SentinelIterator=t.SentinelConnector=t.AbstractConnector=t.Pipeline=t.ScanStream=t.Command=t.Cluster=t.Redis=t.default=void 0,t=e.exports=Ri().default;var s=Ri();Object.defineProperty(t,"default",{enumerable:!0,get:function(){return s.default}});var r=Ri();Object.defineProperty(t,"Redis",{enumerable:!0,get:function(){return r.default}});var i=xr();Object.defineProperty(t,"Cluster",{enumerable:!0,get:function(){return i.default}});var n=lt;Object.defineProperty(t,"Command",{enumerable:!0,get:function(){return n.default}});var o=Ps;Object.defineProperty(t,"ScanStream",{enumerable:!0,get:function(){return o.default}});var a=Ds;Object.defineProperty(t,"Pipeline",{enumerable:!0,get:function(){return a.default}});var l=Rr;Object.defineProperty(t,"AbstractConnector",{enumerable:!0,get:function(){return l.default}});var c=Gr();Object.defineProperty(t,"SentinelConnector",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(t,"SentinelIterator",{enumerable:!0,get:function(){return c.SentinelIterator}}),t.ReplyError=at.ReplyError,Object.defineProperty(t,"Promise",{get:()=>(console.warn("ioredis v5 does not support plugging third-party Promise library anymore. Native Promise will be used."),Promise),set(e){console.warn("ioredis v5 does not support plugging third-party Promise library anymore. Native Promise will be used.")}}),t.print=function(e,t){e?console.log("Error: "+e):console.log("Reply: "+t)}}(We,Ye);var Mi=O(Ye);module.exports=class{#e={};#t;#s;#r;constructor(e){e=Object.assign({prefix:"myapp",host:"127.0.0.1",port:6379,debug:!1},e),this.#s=e.prefix,this.#r=e.debug,this.#t=new Mi({host:e.host,port:e.port,lazyConnect:!0,retryStrategy:()=>null,connectTimeout:1500})}async consume(t){t=Object.assign({maxRetry:3,disconnect:!1},t);try{let s=0;for(;null==t.maxRetry||-1===t.maxRetry||s++<t.maxRetry;){this.#r&&console.log(`Consumption (${s}/${t.maxRetry})`);const r=await this.#i();t.disconnect&&e.execSync("sudo systemctl stop redis");if(!await new Promise(((e,t)=>{this.#e[r.region].consume(r.region).then((()=>{e(!0)})).catch((async s=>{s instanceof Error?t(s):e(!1)}))}))){if(t.maxRetry&&-1!==t.maxRetry){const e=await this.getTimeUntilAllocation();this.#r&&console.log(`Wait ${e}ms until next available for allocation`),await new Promise((t=>setTimeout(t,e)));continue}break}return r.region}return}catch(e){throw e}finally{t.disconnect&&e.execSync("sudo systemctl start redis")}}async register(e){if(e=Object.assign({region:void 0,quota:void 0,duration:void 0},e),this.#e[e.region])throw new Error(`The region name for ${e.region} has already been registered.`);"wait"===this.#t.status&&await this.#t.connect(),this.#e[e.region]=new qe.RateLimiterRedis({storeClient:this.#t,keyPrefix:this.#s+":rl",points:e.quota,duration:e.duration,blockDuration:0})}async getTimeUntilAllocation(){return(await this.#i()).duration}async#i(){let e=[];for(let[t,s]of Object.entries(this.#e)){let r=0,i=0;const n=await s.get(t);n&&(r=1-n.remainingPoints/s.points,i=n.msBeforeNext),e.push({region:t,allocationRate:r,duration:i})}const t=Math.min(...e.map((e=>e.allocationRate)));if(e=e.filter((e=>e.allocationRate===t)),e.length>0){const t=Math.min(...e.map((e=>e.duration)));e=e.filter((e=>e.duration===t))}return e[Math.floor(Math.random()*e.length)]}};
